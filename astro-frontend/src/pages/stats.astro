---
import Layout from '../layouts/Layout.astro';
import PlayerProfileWidget from '../components/PlayerProfileWidget.astro';
import TeamProfileWidget from '../components/TeamProfileWidget.astro';
import PlayerStatsContentCard from '../components/PlayerStatsContentCard.astro';
import TeamStatsContentCard from '../components/TeamStatsContentCard.astro';
import ComparisonSearchModal from '../components/ComparisonSearchModal.astro';
import ProfileWidgetComparison from '../components/ProfileWidgetComparison.astro';
import StatsComparison from '../components/StatsComparison.astro';
---

<Layout
  title="Stats - Scoracle"
  description="View detailed statistics, comparisons, and predictions for sports players and teams"
>
  <main class="stats-main">
    <!-- Single Entity View - Player -->
    <div id="player-entity-view" class="entity-view hidden" data-entity-type="player">
      <PlayerProfileWidget page="stats" showCompareButton={true} />
      <PlayerStatsContentCard title="Statistics" />
    </div>

    <!-- Single Entity View - Team -->
    <div id="team-entity-view" class="entity-view hidden" data-entity-type="team">
      <TeamProfileWidget page="stats" showCompareButton={true} />
      <TeamStatsContentCard title="Statistics" />
    </div>

    <!-- Comparison View (hidden by default) -->
    <div id="comparison-view" class="comparison-view hidden">
      <ProfileWidgetComparison />
      <StatsComparison title="Statistics Comparison" />
    </div>

    <!-- Comparison Search Modal -->
    <ComparisonSearchModal />
  </main>
</Layout>

<style>
  .stats-main {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1.5rem;
    padding: 2rem 1rem 3rem;
    min-height: calc(100vh - 3.5rem);
    background-color: var(--bg);
  }

  :global(.dark) .stats-main {
    background-color: var(--bg-dark);
  }

  .entity-view {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1.5rem;
    width: 100%;
  }

  .entity-view.hidden {
    display: none;
  }

  .comparison-view {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1.5rem;
    width: 100%;
  }

  .comparison-view.hidden {
    display: none;
  }
</style>

<script>
  import type { AutocompleteEntity } from '../lib/utils/autocomplete';

  /**
   * Entity Page Manager
   *
   * Handles:
   * - Showing the correct entity view (player vs team) based on URL params
   * - Managing comparison mode
   */
  class EntityPageManager {
    private playerView: HTMLElement | null = null;
    private teamView: HTMLElement | null = null;
    private comparisonView: HTMLElement | null = null;

    private entityType: 'player' | 'team' = 'player';
    private primarySport: string = '';
    private primaryType: string = '';
    private primaryId: string = '';
    private primaryName: string = '';

    private secondaryType: string = '';
    private secondaryId: string = '';
    private secondaryName: string = '';

    constructor() {
      this.playerView = document.getElementById('player-entity-view');
      this.teamView = document.getElementById('team-entity-view');
      this.comparisonView = document.getElementById('comparison-view');

      this.init();
      this.bindEvents();
    }

    private init() {
      // Read entity type from URL params
      const params = new URLSearchParams(window.location.search);
      const type = params.get('type');
      this.entityType = type === 'team' ? 'team' : 'player';

      // Show the appropriate view
      this.showEntityView();
    }

    private showEntityView() {
      if (this.entityType === 'team') {
        this.playerView?.classList.add('hidden');
        this.teamView?.classList.remove('hidden');
      } else {
        this.playerView?.classList.remove('hidden');
        this.teamView?.classList.add('hidden');
      }
    }

    private bindEvents() {
      // Listen for comparison add request
      window.addEventListener('comparison:add', ((event: CustomEvent) => {
        const { sport, type, id, name } = event.detail;
        this.primarySport = sport;
        this.primaryType = type;
        this.primaryId = id;
        this.primaryName = name;

        this.openComparisonModal();
      }) as EventListener);

      // Listen for comparison removal
      window.addEventListener('comparison:removed', () => {
        this.exitComparisonMode();
      });
    }

    private openComparisonModal() {
      const modal = (window as any).comparisonModal;
      if (modal) {
        modal.open(
          this.primarySport,
          this.primaryType,
          this.primaryId,
          (entity: AutocompleteEntity) => {
            this.onComparisonSelected(entity);
          }
        );
      }
    }

    private onComparisonSelected(entity: AutocompleteEntity) {
      this.secondaryType = entity.type;
      this.secondaryId = entity.id;
      this.secondaryName = entity.name;

      this.enterComparisonMode();
    }

    private enterComparisonMode() {
      // Hide both single entity views
      this.playerView?.classList.add('hidden');
      this.teamView?.classList.add('hidden');

      // Show comparison view
      this.comparisonView?.classList.remove('hidden');

      // Initialize comparison widgets
      const widgetComparison = (window as any).profileWidgetComparison;
      if (widgetComparison) {
        widgetComparison.show(
          this.primarySport,
          this.primaryType,
          this.primaryId,
          this.secondaryType,
          this.secondaryId
        );
      }

      // Initialize comparison stats widget
      const statsComparison = (window as any).statsComparison;
      if (statsComparison) {
        statsComparison.show(
          this.primarySport,
          this.primaryType,
          this.primaryId,
          this.secondaryType,
          this.secondaryId,
          this.primaryName,
          this.secondaryName
        );
      }

      // Update URL with comparison params
      this.updateURL();
    }

    private exitComparisonMode() {
      // Hide comparison view
      this.comparisonView?.classList.add('hidden');

      // Show the appropriate single entity view
      this.showEntityView();

      // Hide comparison components
      const widgetComparison = (window as any).profileWidgetComparison;
      if (widgetComparison) widgetComparison.hide();

      const statsComparison = (window as any).statsComparison;
      if (statsComparison) statsComparison.hide();

      // Reset secondary entity
      this.secondaryType = '';
      this.secondaryId = '';
      this.secondaryName = '';

      // Remove comparison params from URL
      this.removeComparisonFromURL();
    }

    private updateURL() {
      const url = new URL(window.location.href);
      url.searchParams.set('compareType', this.secondaryType);
      url.searchParams.set('compareId', this.secondaryId);
      window.history.replaceState({}, '', url.toString());
    }

    private removeComparisonFromURL() {
      const url = new URL(window.location.href);
      url.searchParams.delete('compareType');
      url.searchParams.delete('compareId');
      window.history.replaceState({}, '', url.toString());
    }

    /**
     * Check if comparison params exist in URL and restore comparison mode
     */
    public checkURLForComparison() {
      const params = new URLSearchParams(window.location.search);
      const compareType = params.get('compareType');
      const compareId = params.get('compareId');

      if (compareType && compareId) {
        // Wait for profile widget to load and provide primary entity info
        const checkWidget = () => {
          const widget = this.entityType === 'team'
            ? (window as any).teamProfileWidget
            : (window as any).playerProfileWidget;

          if (widget && widget.getSport && widget.getSport()) {
            this.primarySport = widget.getSport();
            this.primaryType = widget.getType();
            this.primaryId = widget.getId();
            this.primaryName = widget.getName() || 'Primary';

            this.secondaryType = compareType;
            this.secondaryId = compareId;
            this.secondaryName = 'Comparison';

            this.enterComparisonMode();
          } else {
            // Retry after a short delay
            setTimeout(checkWidget, 100);
          }
        };

        setTimeout(checkWidget, 200);
      }
    }
  }

  // Initialize
  const manager = new EntityPageManager();

  // Check for comparison in URL after page load
  document.addEventListener('DOMContentLoaded', () => {
    manager.checkURLForComparison();
  });
</script>
