---
/**
 * Stats Tab Component
 *
 * Displays raw entity statistics in a table format.
 * Fetches: GET /api/v1/stats/{entity_type}/{entity_id}
 *
 * Features:
 * - Categorized stat tables showing raw values
 * - Season display
 * - Lazy loading support via window.statsTab.load()
 */

interface Props {
  title?: string;
}

const { title = 'Statistics' } = Astro.props;
const apiUrl = import.meta.env.PUBLIC_API_URL || 'http://localhost:8000/api/v1';
---

<div id="stats-tab-content" data-api-url={apiUrl}>
  <!-- Header -->
  <div class="stats-header">
    <h3 class="stats-title">{title}</h3>
    <span id="stats-season" class="stats-season"></span>
  </div>

  <!-- Stats Categories -->
  <div class="stats-body">
    <!-- Loading State -->
    <div id="stats-loading" class="stats-loading">
      <div class="category-skeleton">
        <div class="skeleton-header"></div>
        <div class="skeleton-rows">
          <div class="skeleton-row"></div>
          <div class="skeleton-row"></div>
          <div class="skeleton-row"></div>
        </div>
      </div>
      <div class="category-skeleton">
        <div class="skeleton-header"></div>
        <div class="skeleton-rows">
          <div class="skeleton-row"></div>
          <div class="skeleton-row"></div>
        </div>
      </div>
    </div>

    <!-- Categories Container -->
    <div id="stats-categories" class="stats-categories hidden">
      <!-- Categories populated by JavaScript -->
    </div>

    <!-- Empty State -->
    <div id="stats-empty" class="stats-empty hidden">
      <p>No statistics available</p>
    </div>

    <!-- Error State -->
    <div id="stats-error" class="stats-error hidden">
      <p>Unable to load statistics</p>
    </div>
  </div>
</div>

<style>
  /* Stats Header */
  .stats-header {
    padding: 1.25rem 1.5rem 1rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  :global(.dark) .stats-header {
    border-bottom-color: var(--border-dark);
  }

  .stats-title {
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
    color: var(--text);
    line-height: 1.4;
  }

  :global(.dark) .stats-title {
    color: var(--text-dark);
  }

  .stats-season {
    font-size: 0.8rem;
    color: var(--text-secondary);
    font-weight: 500;
  }

  :global(.dark) .stats-season {
    color: var(--text-secondary-dark);
  }

  /* Stats Body */
  .stats-body {
    padding: 0 1.5rem 1.25rem;
  }

  /* Loading Skeleton */
  .stats-loading {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
    padding-top: 1rem;
  }

  .category-skeleton {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .skeleton-header {
    width: 30%;
    height: 14px;
    background: var(--border);
    border-radius: 3px;
    animation: pulse 1.5s ease-in-out infinite;
  }

  .skeleton-rows {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .skeleton-row {
    height: 28px;
    background: var(--border);
    border-radius: 3px;
    animation: pulse 1.5s ease-in-out infinite;
  }

  :global(.dark) .skeleton-header,
  :global(.dark) .skeleton-row {
    background: var(--border-dark);
  }

  @keyframes pulse {
    0%,
    100% {
      opacity: 1;
    }
    50% {
      opacity: 0.5;
    }
  }

  /* Categories */
  .stats-categories {
    display: flex;
    flex-direction: column;
  }

  .stats-categories :global(.stats-category) {
    padding: 1rem 0;
    border-bottom: 1px solid var(--border);
  }

  .stats-categories :global(.stats-category:first-child) {
    padding-top: 1.25rem;
  }

  .stats-categories :global(.stats-category:last-child) {
    border-bottom: none;
    padding-bottom: 0;
  }

  :global(.dark) .stats-categories :global(.stats-category) {
    border-bottom-color: var(--border-dark);
  }

  .stats-categories :global(.category-header) {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.625rem;
  }

  .stats-categories :global(.category-indicator) {
    width: 3px;
    height: 14px;
    border-radius: 2px;
    flex-shrink: 0;
  }

  .stats-categories :global(.category-title) {
    margin: 0;
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--text);
    text-transform: uppercase;
    letter-spacing: 0.025em;
  }

  :global(.dark) .stats-categories :global(.category-title) {
    color: var(--text-dark);
  }

  .stats-categories :global(.category-stats) {
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
  }

  .stats-categories :global(.stat-row) {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.375rem 0;
  }

  .stats-categories :global(.stat-label) {
    font-size: 0.875rem;
    color: var(--text-secondary);
    flex: 1;
  }

  :global(.dark) .stats-categories :global(.stat-label) {
    color: var(--text-secondary-dark);
  }

  .stats-categories :global(.stat-value) {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text);
    font-variant-numeric: tabular-nums;
    min-width: 48px;
    text-align: right;
  }

  :global(.dark) .stats-categories :global(.stat-value) {
    color: var(--text-dark);
  }

  /* Empty & Error States */
  .stats-empty,
  .stats-error {
    padding: 2rem 0;
    text-align: center;
  }

  .stats-empty p,
  .stats-error p {
    margin: 0;
    font-size: 0.9rem;
    color: var(--text-tertiary);
  }

  :global(.dark) .stats-empty p,
  :global(.dark) .stats-error p {
    color: var(--text-tertiary-dark);
  }

  /* Utility */
  .hidden {
    display: none !important;
  }

  /* Responsive - Mobile */
  @media (max-width: 480px) {
    .stats-header {
      padding: 1rem;
      flex-direction: column;
      align-items: flex-start;
      gap: 0.25rem;
    }

    .stats-title {
      font-size: 0.9rem;
    }

    .stats-season {
      font-size: 0.75rem;
    }

    .stats-body {
      padding: 0 1rem 1rem;
    }

    .stats-categories :global(.stat-row) {
      flex-wrap: wrap;
      gap: 0.25rem;
    }

    .stats-categories :global(.stat-value) {
      font-size: 0.8rem;
      min-width: 40px;
    }
  }

  /* Extra small screens */
  @media (max-width: 320px) {
    .stats-header {
      padding: 0.75rem;
    }

    .stats-body {
      padding: 0 0.75rem 0.75rem;
    }
  }
</style>

<script>
  import { escapeHtml, parseEntityParams } from '../../lib/utils/dom';
  import { swrFetch, setPageData, CACHE_PRESETS } from '../../lib/utils/api-fetcher';
  import { categorizeStats, type StatItem, type Category } from '../../lib/utils/stats-categorizer';

  // API Response types matching scoracle-data backend
  interface StatsResponse {
    entity_id: number;
    entity_type: 'player' | 'team';
    sport: string;
    season: number;
    info: {
      id: number;
      first_name?: string;
      last_name?: string;
      full_name?: string;
      name?: string;
      position?: string;
      team?: { name: string };
    };
    stats: Record<string, unknown>;
    percentiles: Array<{ stat_key: string; percentile: number }> | Record<string, number>;
  }

  /**
   * Stats Tab Manager
   *
   * Handles loading stats from the backend API and populating
   * category tables with raw stat values.
   */
  class StatsTabManager {
    private container: HTMLElement | null;
    private apiUrl: string;
    private loaded = false;

    constructor() {
      this.container = document.getElementById('stats-tab-content');
      this.apiUrl = this.container?.dataset.apiUrl || '';
    }

    async load(): Promise<void> {
      if (this.loaded || !this.container) return;
      this.loaded = true;

      const params = parseEntityParams();
      const { sport, type, id } = params;

      if (!sport || !type || !id) {
        this.showError();
        return;
      }

      try {
        await this.loadStats(sport, type, id);
      } catch (error) {
        if (import.meta.env.DEV) {
          console.error('Failed to load stats:', error);
        }
        this.showError();
      }
    }

    private async loadStats(sport: string, type: string, id: string) {
      const url = `${this.apiUrl}/stats/${type}/${id}?sport=${sport.toUpperCase()}`;

      const { data } = await swrFetch<StatsResponse>(url, CACHE_PRESETS.stats);

      if (!data || !data.stats) {
        this.showEmpty();
        return;
      }

      // Transform flat stats into categorized format (no percentiles needed for raw stats)
      const categories = categorizeStats(data.stats, {}, sport);

      if (categories.length === 0) {
        this.showEmpty();
        return;
      }

      // Share data with other components
      setPageData('stats', {
        season: data.season,
        entity: {
          id: String(data.entity_id),
          name: data.info?.full_name || data.info?.name || '',
          type: data.entity_type,
        },
        categories: categories,
      });

      // Update season display
      const seasonEl = this.container?.querySelector('#stats-season');
      if (seasonEl) {
        seasonEl.textContent = `${data.season} Season`;
      }

      // Render category tables
      this.renderCategories(categories);
    }

    private renderCategories(categories: Category[]) {
      const container = this.container?.querySelector('#stats-categories');
      if (!container) return;

      container.innerHTML = categories
        .map(
          (category) => `
        <div class="stats-category" data-category="${category.id}">
          <div class="category-header">
            <div class="category-indicator" style="background: var(--category-${category.id}, var(--accent))"></div>
            <h4 class="category-title">${escapeHtml(category.label)}</h4>
          </div>
          <div class="category-stats">
            ${category.stats.map((stat) => this.renderStatRow(stat)).join('')}
          </div>
        </div>
      `
        )
        .join('');

      this.showContent();
    }

    private renderStatRow(stat: StatItem): string {
      const displayValue = stat.value !== null ? String(stat.value) : '-';

      return `
        <div class="stat-row">
          <span class="stat-label">${escapeHtml(stat.label)}</span>
          <span class="stat-value">${escapeHtml(displayValue)}</span>
        </div>
      `;
    }

    private showContent() {
      this.container?.querySelector('#stats-loading')?.classList.add('hidden');
      this.container?.querySelector('#stats-categories')?.classList.remove('hidden');
      this.container?.querySelector('#stats-empty')?.classList.add('hidden');
      this.container?.querySelector('#stats-error')?.classList.add('hidden');
    }

    private showEmpty() {
      this.container?.querySelector('#stats-loading')?.classList.add('hidden');
      this.container?.querySelector('#stats-categories')?.classList.add('hidden');
      this.container?.querySelector('#stats-empty')?.classList.remove('hidden');
      this.container?.querySelector('#stats-error')?.classList.add('hidden');
    }

    private showError() {
      this.container?.querySelector('#stats-loading')?.classList.add('hidden');
      this.container?.querySelector('#stats-categories')?.classList.add('hidden');
      this.container?.querySelector('#stats-empty')?.classList.add('hidden');
      this.container?.querySelector('#stats-error')?.classList.remove('hidden');
    }
  }

  // Initialize manager and expose on window
  const manager = new StatsTabManager();
  (window as any).statsTab = {
    load: () => manager.load(),
  };

  // Auto-load if this is the active tab (stats tab is default)
  // This maintains backward compatibility
  manager.load();
</script>
