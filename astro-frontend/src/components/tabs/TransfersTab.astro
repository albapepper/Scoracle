---
/**
 * Transfers Tab Component
 *
 * Displays transfer predictions for players or teams.
 * Players: GET /api/v1/ml/transfers/predictions/player/{player_id}
 * Teams: GET /api/v1/ml/transfers/predictions/{team_id}?sport={sport}
 *
 * Features:
 * - Linked teams for players
 * - Target players for teams
 * - Probability with confidence intervals
 * - Trend indicators
 */

const apiUrl = import.meta.env.PUBLIC_API_URL || 'http://localhost:8000/api/v1';
---

<div id="transfers-tab-content" data-api-url={apiUrl}>
  <div id="transfers-loading" class="loading-skeleton">
    <div class="skeleton-item"></div>
    <div class="skeleton-item"></div>
    <div class="skeleton-item"></div>
  </div>

  <div id="transfers-player-content" class="hidden">
    <div id="player-current-team" class="current-team-info"></div>
    <ul id="player-links-list" class="transfer-list"></ul>
  </div>

  <div id="transfers-team-content" class="hidden">
    <ul id="team-targets-list" class="transfer-list"></ul>
  </div>

  <div id="transfers-empty" class="empty-state hidden">
    No transfer rumors available
  </div>

  <div id="transfers-error" class="empty-state hidden">
    Unable to load transfer data
  </div>
</div>

<style>
  .loading-skeleton {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .skeleton-item {
    height: 72px;
    border-radius: 6px;
    background-color: var(--border);
    animation: pulse 2s ease-in-out infinite;
  }

  :global(.dark) .skeleton-item {
    background-color: var(--border-dark);
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  .current-team-info {
    padding: 0.75rem;
    background: var(--border);
    border-radius: 6px;
    font-size: 0.8rem;
    color: var(--text-secondary);
    margin-bottom: 1rem;
  }

  :global(.dark) .current-team-info {
    background: var(--border-dark);
    color: var(--text-secondary-dark);
  }

  .transfer-list {
    list-style: none;
    margin: 0;
    padding: 0;
  }

  #transfers-tab-content :global(.transfer-item) {
    padding: 0.875rem 0;
    border-bottom: 1px solid var(--border);
  }

  #transfers-tab-content :global(.transfer-item:last-child) {
    border-bottom: none;
  }

  :global(.dark) #transfers-tab-content :global(.transfer-item) {
    border-bottom-color: var(--border-dark);
  }

  #transfers-tab-content :global(.transfer-item-header) {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.5rem;
  }

  #transfers-tab-content :global(.transfer-item-name) {
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--text);
    margin: 0;
  }

  :global(.dark) #transfers-tab-content :global(.transfer-item-name) {
    color: var(--text-dark);
  }

  #transfers-tab-content :global(.transfer-item-team) {
    font-size: 0.75rem;
    color: var(--text-secondary);
    margin-top: 0.125rem;
  }

  :global(.dark) #transfers-tab-content :global(.transfer-item-team) {
    color: var(--text-secondary-dark);
  }

  #transfers-tab-content :global(.transfer-item-stats) {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-shrink: 0;
  }

  #transfers-tab-content :global(.probability-badge) {
    font-size: 0.8rem;
    font-weight: 600;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-variant-numeric: tabular-nums;
  }

  #transfers-tab-content :global(.probability-badge.high) {
    background: rgba(34, 197, 94, 0.15);
    color: #16a34a;
  }

  #transfers-tab-content :global(.probability-badge.medium) {
    background: rgba(245, 158, 11, 0.15);
    color: #d97706;
  }

  #transfers-tab-content :global(.probability-badge.low) {
    background: rgba(107, 114, 128, 0.15);
    color: #6b7280;
  }

  :global(.dark) #transfers-tab-content :global(.probability-badge.high) {
    background: rgba(34, 197, 94, 0.2);
    color: #4ade80;
  }

  :global(.dark) #transfers-tab-content :global(.probability-badge.medium) {
    background: rgba(245, 158, 11, 0.2);
    color: #fbbf24;
  }

  :global(.dark) #transfers-tab-content :global(.probability-badge.low) {
    background: rgba(107, 114, 128, 0.2);
    color: #9ca3af;
  }

  #transfers-tab-content :global(.trend-badge) {
    font-size: 0.75rem;
    font-weight: 500;
  }

  #transfers-tab-content :global(.trend-badge.up) {
    color: #16a34a;
  }

  #transfers-tab-content :global(.trend-badge.down) {
    color: #dc2626;
  }

  #transfers-tab-content :global(.trend-badge.stable) {
    color: #6b7280;
  }

  :global(.dark) #transfers-tab-content :global(.trend-badge.up) {
    color: #4ade80;
  }

  :global(.dark) #transfers-tab-content :global(.trend-badge.down) {
    color: #f87171;
  }

  :global(.dark) #transfers-tab-content :global(.trend-badge.stable) {
    color: #9ca3af;
  }

  #transfers-tab-content :global(.probability-bar) {
    height: 4px;
    background: var(--border);
    border-radius: 2px;
    overflow: hidden;
    margin-bottom: 0.5rem;
  }

  :global(.dark) #transfers-tab-content :global(.probability-bar) {
    background: var(--border-dark);
  }

  #transfers-tab-content :global(.probability-bar-fill) {
    height: 100%;
    border-radius: 2px;
    transition: width 0.3s ease;
  }

  #transfers-tab-content :global(.probability-bar-fill.high) {
    background: #22c55e;
  }

  #transfers-tab-content :global(.probability-bar-fill.medium) {
    background: #f59e0b;
  }

  #transfers-tab-content :global(.probability-bar-fill.low) {
    background: #6b7280;
  }

  #transfers-tab-content :global(.confidence-interval) {
    font-size: 0.7rem;
    color: var(--text-tertiary);
    margin-top: 0.25rem;
  }

  :global(.dark) #transfers-tab-content :global(.confidence-interval) {
    color: var(--text-tertiary-dark);
  }

  #transfers-tab-content :global(.transfer-factors) {
    display: flex;
    flex-wrap: wrap;
    gap: 0.375rem;
    margin-top: 0.5rem;
  }

  #transfers-tab-content :global(.factor-tag) {
    font-size: 0.7rem;
    padding: 0.125rem 0.375rem;
    background: var(--border);
    color: var(--text-secondary);
    border-radius: 3px;
  }

  :global(.dark) #transfers-tab-content :global(.factor-tag) {
    background: var(--border-dark);
    color: var(--text-secondary-dark);
  }

  .empty-state {
    text-align: center;
    padding: 2rem;
    color: var(--text-secondary);
  }

  :global(.dark) .empty-state {
    color: var(--text-secondary-dark);
  }

  .hidden {
    display: none !important;
  }
</style>

<script>
  import { parseEntityParams, escapeHtml } from '../../lib/utils/dom';
  import { swrFetch, setPageData, CACHE_PRESETS } from '../../lib/utils/api-fetcher';
  import type { PlayerTransferLinks, TeamTransferPredictions, LinkedTeam, TransferTarget } from '../../lib/types';

  class TransfersTabManager {
    private container: HTMLElement | null;
    private apiUrl: string;
    private loaded = false;

    constructor() {
      this.container = document.getElementById('transfers-tab-content');
      this.apiUrl = this.container?.dataset.apiUrl || '';
    }

    async load(): Promise<void> {
      if (this.loaded || !this.container) return;
      this.loaded = true;

      const params = parseEntityParams();
      const { sport, type, id } = params;

      if (!sport || !type || !id) {
        this.showError();
        return;
      }

      try {
        if (type === 'player') {
          await this.loadPlayerTransfers(id);
        } else {
          await this.loadTeamTransfers(id, sport);
        }
      } catch (err) {
        if (import.meta.env.DEV) {
          console.error('TransfersTab error:', err);
        }
        this.showError();
      }
    }

    private async loadPlayerTransfers(playerId: string): Promise<void> {
      const url = `${this.apiUrl}/ml/transfers/predictions/player/${playerId}`;
      const { data } = await swrFetch<PlayerTransferLinks>(url, CACHE_PRESETS.ml);

      if (!data || !data.linked_teams || data.linked_teams.length === 0) {
        this.showEmpty();
        return;
      }

      setPageData('ml', { transfer: data });

      const currentTeamEl = this.container?.querySelector('#player-current-team');
      if (currentTeamEl && data.current_team) {
        currentTeamEl.textContent = `Currently at ${data.current_team}`;
      }

      this.renderPlayerLinks(data.linked_teams);
      this.showPlayerContent();
    }

    private async loadTeamTransfers(teamId: string, sport: string): Promise<void> {
      const url = `${this.apiUrl}/ml/transfers/predictions/${teamId}?sport=${sport.toUpperCase()}`;
      const { data } = await swrFetch<TeamTransferPredictions>(url, CACHE_PRESETS.ml);

      if (!data || !data.predictions || data.predictions.length === 0) {
        this.showEmpty();
        return;
      }

      setPageData('ml', { transfer: data });
      this.renderTeamTargets(data.predictions);
      this.showTeamContent();
    }

    private renderPlayerLinks(links: LinkedTeam[]): void {
      const list = this.container?.querySelector('#player-links-list');
      if (!list) return;

      list.innerHTML = links.map(link => {
        const probPercent = Math.round(link.probability * 100);
        const probClass = probPercent >= 60 ? 'high' : probPercent >= 30 ? 'medium' : 'low';
        const trendArrow = link.trend === 'up' ? '↑' : link.trend === 'down' ? '↓' : '→';
        const [ciLow, ciHigh] = link.confidence_interval || [0, 0];

        return `
          <li class="transfer-item">
            <div class="transfer-item-header">
              <div>
                <p class="transfer-item-name">${escapeHtml(link.team_name)}</p>
              </div>
              <div class="transfer-item-stats">
                <span class="probability-badge ${probClass}">${probPercent}%</span>
                <span class="trend-badge ${link.trend}">${trendArrow}</span>
              </div>
            </div>
            <div class="probability-bar">
              <div class="probability-bar-fill ${probClass}" style="width: ${probPercent}%"></div>
            </div>
            <div class="confidence-interval">
              Confidence: ${Math.round(ciLow * 100)}% - ${Math.round(ciHigh * 100)}%
            </div>
          </li>
        `;
      }).join('');
    }

    private renderTeamTargets(targets: TransferTarget[]): void {
      const list = this.container?.querySelector('#team-targets-list');
      if (!list) return;

      list.innerHTML = targets.map(target => {
        const probPercent = Math.round(target.probability * 100);
        const probClass = probPercent >= 60 ? 'high' : probPercent >= 30 ? 'medium' : 'low';
        const trendArrow = target.trend === 'up' ? '↑' : target.trend === 'down' ? '↓' : '→';
        const [ciLow, ciHigh] = target.confidence_interval || [0, 0];
        const factors = (target.top_factors || []).slice(0, 3);

        return `
          <li class="transfer-item">
            <div class="transfer-item-header">
              <div>
                <p class="transfer-item-name">${escapeHtml(target.player_name)}</p>
                <span class="transfer-item-team">${escapeHtml(target.current_team)}</span>
              </div>
              <div class="transfer-item-stats">
                <span class="probability-badge ${probClass}">${probPercent}%</span>
                <span class="trend-badge ${target.trend}">${trendArrow}</span>
              </div>
            </div>
            <div class="probability-bar">
              <div class="probability-bar-fill ${probClass}" style="width: ${probPercent}%"></div>
            </div>
            <div class="confidence-interval">
              Confidence: ${Math.round(ciLow * 100)}% - ${Math.round(ciHigh * 100)}%
            </div>
            ${factors.length > 0 ? `
              <div class="transfer-factors">
                ${factors.map(f => `<span class="factor-tag">${escapeHtml(f)}</span>`).join('')}
              </div>
            ` : ''}
          </li>
        `;
      }).join('');
    }

    private showPlayerContent(): void {
      this.container?.querySelector('#transfers-loading')?.classList.add('hidden');
      this.container?.querySelector('#transfers-player-content')?.classList.remove('hidden');
      this.container?.querySelector('#transfers-team-content')?.classList.add('hidden');
      this.container?.querySelector('#transfers-empty')?.classList.add('hidden');
      this.container?.querySelector('#transfers-error')?.classList.add('hidden');
    }

    private showTeamContent(): void {
      this.container?.querySelector('#transfers-loading')?.classList.add('hidden');
      this.container?.querySelector('#transfers-player-content')?.classList.add('hidden');
      this.container?.querySelector('#transfers-team-content')?.classList.remove('hidden');
      this.container?.querySelector('#transfers-empty')?.classList.add('hidden');
      this.container?.querySelector('#transfers-error')?.classList.add('hidden');
    }

    private showEmpty(): void {
      this.container?.querySelector('#transfers-loading')?.classList.add('hidden');
      this.container?.querySelector('#transfers-player-content')?.classList.add('hidden');
      this.container?.querySelector('#transfers-team-content')?.classList.add('hidden');
      this.container?.querySelector('#transfers-empty')?.classList.remove('hidden');
      this.container?.querySelector('#transfers-error')?.classList.add('hidden');
    }

    private showError(): void {
      this.container?.querySelector('#transfers-loading')?.classList.add('hidden');
      this.container?.querySelector('#transfers-player-content')?.classList.add('hidden');
      this.container?.querySelector('#transfers-team-content')?.classList.add('hidden');
      this.container?.querySelector('#transfers-empty')?.classList.add('hidden');
      this.container?.querySelector('#transfers-error')?.classList.remove('hidden');
    }
  }

  const manager = new TransfersTabManager();
  (window as any).transfersTab = { load: () => manager.load() };
</script>
