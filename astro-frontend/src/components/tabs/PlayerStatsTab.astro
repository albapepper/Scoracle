---
/**
 * Player Stats Tab Component
 *
 * Displays player statistics with:
 * - Pizza chart for percentile visualization (color-coded: red=low, green=high)
 * - Box score table with raw per-game stats in horizontal format
 *
 * Fetches: GET /api/v1/stats/player/{player_id}?sport={sport}
 */

interface Props {
  title?: string;
}

const { title = 'Statistics' } = Astro.props;
const apiUrl = import.meta.env.PUBLIC_API_URL || 'http://localhost:8000/api/v1';
---

<div id="player-stats-tab-content" data-api-url={apiUrl}>
  <!-- Header -->
  <div class="stats-header">
    <h3 class="stats-title">{title}</h3>
    <span id="player-stats-season" class="stats-season"></span>
  </div>

  <!-- Pizza Chart Section -->
  <div id="player-stats-chart-container" class="stats-chart-container">
    <div id="player-stats-pizza-chart" class="stats-pizza-chart"></div>
    <div id="player-stats-chart-loading" class="chart-skeleton">
      <div class="chart-skeleton-circle"></div>
    </div>
  </div>

  <!-- Box Score Section -->
  <div class="stats-body">
    <!-- Loading State -->
    <div id="player-stats-loading" class="stats-loading">
      <div class="box-score-skeleton">
        <div class="skeleton-row-header"></div>
        <div class="skeleton-row-cells">
          <div class="skeleton-cell"></div>
          <div class="skeleton-cell"></div>
          <div class="skeleton-cell"></div>
          <div class="skeleton-cell"></div>
          <div class="skeleton-cell"></div>
        </div>
      </div>
      <div class="box-score-skeleton">
        <div class="skeleton-row-header"></div>
        <div class="skeleton-row-cells">
          <div class="skeleton-cell"></div>
          <div class="skeleton-cell"></div>
          <div class="skeleton-cell"></div>
        </div>
      </div>
    </div>

    <!-- Box Score Container -->
    <div id="player-stats-box-score" class="stats-box-score hidden">
      <!-- Box score groups populated by JavaScript -->
    </div>

    <!-- Empty State -->
    <div id="player-stats-empty" class="stats-empty hidden">
      <p>No statistics available</p>
    </div>

    <!-- Error State -->
    <div id="player-stats-error" class="stats-error hidden">
      <p>Unable to load statistics</p>
    </div>
  </div>
</div>

<style>
  /* Stats Header */
  .stats-header {
    padding: 1.25rem 1.5rem 1rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  :global(.dark) .stats-header {
    border-bottom-color: var(--border-dark);
  }

  .stats-title {
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
    color: var(--text);
    line-height: 1.4;
  }

  :global(.dark) .stats-title {
    color: var(--text-dark);
  }

  .stats-season {
    font-size: 0.8rem;
    color: var(--text-secondary);
    font-weight: 500;
  }

  :global(.dark) .stats-season {
    color: var(--text-secondary-dark);
  }

  /* Chart Container */
  .stats-chart-container {
    padding: 1.5rem 1rem;
    display: flex;
    justify-content: center;
    align-items: center;
    border-bottom: 1px solid var(--border);
    min-height: 280px;
  }

  :global(.dark) .stats-chart-container {
    border-bottom-color: var(--border-dark);
  }

  .stats-pizza-chart {
    width: 100%;
    max-width: 360px;
    display: flex;
    justify-content: center;
  }

  .stats-pizza-chart :global(.pizza-chart-svg) {
    display: block;
  }

  .stats-pizza-chart :global(.chart-no-data) {
    color: var(--text-tertiary);
    font-size: 0.875rem;
    text-align: center;
    margin: 0;
  }

  :global(.dark) .stats-pizza-chart :global(.chart-no-data) {
    color: var(--text-tertiary-dark);
  }

  /* Chart Skeleton */
  .chart-skeleton {
    width: 200px;
    height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .chart-skeleton-circle {
    width: 180px;
    height: 180px;
    border-radius: 50%;
    background: var(--border);
    animation: pulse 1.5s ease-in-out infinite;
  }

  :global(.dark) .chart-skeleton-circle {
    background: var(--border-dark);
  }

  /* Stats Body */
  .stats-body {
    padding: 1rem 1.5rem 1.25rem;
  }

  /* Loading Skeleton */
  .stats-loading {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .box-score-skeleton {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .skeleton-row-header {
    width: 80px;
    height: 12px;
    background: var(--border);
    border-radius: 3px;
    animation: pulse 1.5s ease-in-out infinite;
  }

  .skeleton-row-cells {
    display: flex;
    gap: 0.5rem;
  }

  .skeleton-cell {
    width: 48px;
    height: 44px;
    background: var(--border);
    border-radius: 4px;
    animation: pulse 1.5s ease-in-out infinite;
  }

  :global(.dark) .skeleton-row-header,
  :global(.dark) .skeleton-cell {
    background: var(--border-dark);
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  /* Box Score */
  .stats-box-score {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }

  .stats-box-score :global(.box-score-group) {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .stats-box-score :global(.group-label) {
    font-size: 0.7rem;
    font-weight: 600;
    color: var(--text-tertiary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin: 0;
  }

  :global(.dark) .stats-box-score :global(.group-label) {
    color: var(--text-tertiary-dark);
  }

  .stats-box-score :global(.box-score-row) {
    display: flex;
    gap: 0.375rem;
    overflow-x: auto;
    scrollbar-width: none;
    -ms-overflow-style: none;
    padding-bottom: 2px;
  }

  .stats-box-score :global(.box-score-row::-webkit-scrollbar) {
    display: none;
  }

  .stats-box-score :global(.stat-cell) {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-width: 52px;
    padding: 0.5rem 0.625rem;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    flex-shrink: 0;
  }

  :global(.dark) .stats-box-score :global(.stat-cell) {
    background: var(--bg-dark);
    border-color: var(--border-dark);
  }

  .stats-box-score :global(.stat-abbrev) {
    font-size: 0.65rem;
    font-weight: 600;
    color: var(--text-tertiary);
    text-transform: uppercase;
    letter-spacing: 0.02em;
    margin-bottom: 0.125rem;
  }

  :global(.dark) .stats-box-score :global(.stat-abbrev) {
    color: var(--text-tertiary-dark);
  }

  .stats-box-score :global(.stat-value) {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text);
    font-variant-numeric: tabular-nums;
    line-height: 1.2;
  }

  :global(.dark) .stats-box-score :global(.stat-value) {
    color: var(--text-dark);
  }

  /* Empty & Error States */
  .stats-empty,
  .stats-error {
    padding: 2rem 0;
    text-align: center;
  }

  .stats-empty p,
  .stats-error p {
    margin: 0;
    font-size: 0.9rem;
    color: var(--text-tertiary);
  }

  :global(.dark) .stats-empty p,
  :global(.dark) .stats-error p {
    color: var(--text-tertiary-dark);
  }

  /* Utility */
  .hidden {
    display: none !important;
  }

  /* Responsive - Mobile */
  @media (max-width: 480px) {
    .stats-header {
      padding: 1rem;
      flex-direction: column;
      align-items: flex-start;
      gap: 0.25rem;
    }

    .stats-title {
      font-size: 0.9rem;
    }

    .stats-season {
      font-size: 0.75rem;
    }

    .stats-chart-container {
      padding: 1rem;
      min-height: 240px;
    }

    .stats-pizza-chart {
      max-width: 280px;
    }

    .stats-body {
      padding: 1rem;
    }

    .stats-box-score :global(.stat-cell) {
      min-width: 48px;
      padding: 0.375rem 0.5rem;
    }

    .stats-box-score :global(.stat-value) {
      font-size: 0.9rem;
    }
  }

  /* Extra small screens */
  @media (max-width: 320px) {
    .stats-header {
      padding: 0.75rem;
    }

    .stats-body {
      padding: 0.75rem;
    }

    .stats-chart-container {
      min-height: 200px;
    }

    .stats-pizza-chart {
      max-width: 220px;
    }

    .stats-box-score :global(.stat-cell) {
      min-width: 44px;
      padding: 0.25rem 0.375rem;
    }

    .stats-box-score :global(.stat-abbrev) {
      font-size: 0.6rem;
    }

    .stats-box-score :global(.stat-value) {
      font-size: 0.85rem;
    }
  }
</style>

<script>
  import { escapeHtml, parseEntityParams } from '../../lib/utils/dom';
  import { swrFetch, setPageData, getPageData, CACHE_PRESETS } from '../../lib/utils/api-fetcher';
  import { PizzaChart, type PizzaChartStat } from '../../lib/charts/pizza-chart';
  import {
    categorizeStats,
    getBoxScoreGroups,
    type Category,
    type BoxScoreGroup,
  } from '../../lib/utils/stats-categorizer';

  /**
   * Player stats response shape from backend
   */
  interface PlayerStatsResponse {
    entity_id: number;
    entity_type: 'player';
    sport: string;
    season: number;
    stats: Record<string, number | string>;
    percentiles: Record<string, number> | Array<{ stat_key: string; percentile: number }>;
    percentile_metadata?: unknown;
  }

  /**
   * Player Stats Tab Manager
   *
   * Handles loading player stats from the backend API,
   * rendering the pizza chart and box score table.
   */
  class PlayerStatsTabManager {
    private container: HTMLElement | null;
    private apiUrl: string;
    private pizzaChart: PizzaChart | null = null;
    private loaded = false;

    constructor() {
      this.container = document.getElementById('player-stats-tab-content');
      this.apiUrl = this.container?.dataset.apiUrl || '';
    }

    async load(): Promise<void> {
      if (this.loaded || !this.container) return;
      this.loaded = true;

      const params = parseEntityParams();
      const { sport, type, id } = params;

      // Only proceed if this is a player entity
      if (type !== 'player') return;

      if (!sport || !id) {
        this.showError();
        return;
      }

      try {
        await this.loadStats(sport, id);
      } catch (error) {
        if (import.meta.env.DEV) {
          console.error('Failed to load player stats:', error);
        }
        this.showError();
      }
    }

    private async loadStats(sport: string, id: string) {
      const url = `${this.apiUrl}/stats/player/${id}?sport=${sport.toUpperCase()}`;

      const { data } = await swrFetch<PlayerStatsResponse>(url, CACHE_PRESETS.stats);

      if (!data || !data.stats) {
        this.showEmpty();
        return;
      }

      // Normalize percentiles to object format
      const percentiles = this.normalizePercentiles(data.percentiles);

      // Get categorized stats for the pizza chart (using 'player' entity type)
      const categories = categorizeStats(data.stats, percentiles, sport, 'player');

      // Get box score groups (using 'player' entity type)
      const boxScoreGroups = getBoxScoreGroups(data.stats, sport, 'player');

      if (categories.length === 0 && boxScoreGroups.length === 0) {
        this.showEmpty();
        return;
      }

      // Get entity name from player profile widget
      const widgetData = getPageData('widget') as { info?: { full_name?: string; first_name?: string; last_name?: string } } | undefined;
      const entityName = widgetData?.info?.full_name || 
        `${widgetData?.info?.first_name || ''} ${widgetData?.info?.last_name || ''}`.trim() || '';

      // Share data with other components
      setPageData('stats', {
        season: data.season,
        entity: {
          id: String(data.entity_id),
          name: entityName,
          type: 'player',
        },
        categories: categories,
        boxScoreGroups: boxScoreGroups,
      });

      // Update season display
      const seasonEl = this.container?.querySelector('#player-stats-season');
      if (seasonEl) {
        seasonEl.textContent = `${data.season} Season`;
      }

      // Render pizza chart with percentiles
      this.renderChart(categories);

      // Render box score
      this.renderBoxScore(boxScoreGroups);
    }

    private normalizePercentiles(
      percentiles: Record<string, number> | Array<{ stat_key: string; percentile: number }> | undefined
    ): Record<string, number> {
      if (!percentiles) return {};

      if (Array.isArray(percentiles)) {
        const result: Record<string, number> = {};
        for (const p of percentiles) {
          if (p.stat_key && typeof p.percentile === 'number') {
            result[p.stat_key] = p.percentile;
          }
        }
        return result;
      }

      return percentiles as Record<string, number>;
    }

    private renderChart(categories: Category[]) {
      const chartContainer = this.container?.querySelector('#player-stats-pizza-chart') as HTMLElement;
      const chartLoading = this.container?.querySelector('#player-stats-chart-loading');

      if (!chartContainer) return;

      // Collect all stats with percentiles for the chart
      const chartStats: PizzaChartStat[] = [];

      categories.forEach((category) => {
        category.stats.forEach((stat) => {
          if (stat.percentile !== undefined && stat.percentile !== null) {
            chartStats.push({
              key: stat.key,
              label: stat.label,
              value: stat.value ?? '-',
              percentile: stat.percentile,
              categoryId: category.id,
            });
          }
        });
      });

      // Hide loading skeleton
      chartLoading?.classList.add('hidden');

      if (chartStats.length < 3) {
        // Not enough percentile data - hide chart section
        const chartSection = this.container?.querySelector('#player-stats-chart-container');
        chartSection?.classList.add('hidden');
        return;
      }

      // Create and render chart
      this.pizzaChart = new PizzaChart(chartContainer, {
        width: 360,
        height: 360,
        innerRadius: 35,
        outerRadius: 120,
        labelOffset: 30,
      });

      this.pizzaChart.render(chartStats);
    }

    private renderBoxScore(groups: BoxScoreGroup[]) {
      const container = this.container?.querySelector('#player-stats-box-score');
      if (!container) return;

      if (groups.length === 0) {
        const loadingEl = this.container?.querySelector('#player-stats-loading');
        loadingEl?.classList.add('hidden');
        return;
      }

      container.innerHTML = groups
        .map(
          (group) => `
        <div class="box-score-group" data-group="${group.id}">
          <p class="group-label">${escapeHtml(group.label)}</p>
          <div class="box-score-row">
            ${group.stats
              .map(
                (stat) => `
              <div class="stat-cell">
                <span class="stat-abbrev">${escapeHtml(stat.abbrev)}</span>
                <span class="stat-value">${escapeHtml(String(stat.value))}</span>
              </div>
            `
              )
              .join('')}
          </div>
        </div>
      `
        )
        .join('');

      this.showContent();
    }

    private showContent() {
      this.container?.querySelector('#player-stats-loading')?.classList.add('hidden');
      this.container?.querySelector('#player-stats-box-score')?.classList.remove('hidden');
      this.container?.querySelector('#player-stats-empty')?.classList.add('hidden');
      this.container?.querySelector('#player-stats-error')?.classList.add('hidden');
    }

    private showEmpty() {
      this.container?.querySelector('#player-stats-loading')?.classList.add('hidden');
      this.container?.querySelector('#player-stats-box-score')?.classList.add('hidden');
      this.container?.querySelector('#player-stats-empty')?.classList.remove('hidden');
      this.container?.querySelector('#player-stats-error')?.classList.add('hidden');

      // Hide chart if no data
      const chartContainer = this.container?.querySelector('#player-stats-chart-container');
      chartContainer?.classList.add('hidden');
    }

    private showError() {
      this.container?.querySelector('#player-stats-loading')?.classList.add('hidden');
      this.container?.querySelector('#player-stats-box-score')?.classList.add('hidden');
      this.container?.querySelector('#player-stats-empty')?.classList.add('hidden');
      this.container?.querySelector('#player-stats-error')?.classList.remove('hidden');

      // Hide chart on error
      const chartContainer = this.container?.querySelector('#player-stats-chart-container');
      chartContainer?.classList.add('hidden');
    }

    public refreshChart(): void {
      this.pizzaChart?.refresh();
    }
  }

  // Initialize manager and expose on window
  const manager = new PlayerStatsTabManager();
  (window as any).playerStatsTab = {
    load: () => manager.load(),
    refreshChart: () => manager.refreshChart(),
  };

  // Auto-load since Stats is the default tab
  manager.load();

  // Listen for theme changes to refresh chart colors
  const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      if (mutation.attributeName === 'class') {
        manager.refreshChart();
      }
    });
  });

  observer.observe(document.documentElement, { attributes: true });
</script>
