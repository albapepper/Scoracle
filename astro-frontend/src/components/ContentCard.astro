---
/**
 * Content Card with 4 Tabs
 * 
 * Displays content for an entity across 4 tabs:
 * - Articles
 * - Co-mentions
 * - Tweets
 * - Reddit
 * 
 * Used on the mentions page below the entity widget
 * Tab content is populated from the backend API
 */

// Get API URL at build time and pass to client
const apiUrl = import.meta.env.PUBLIC_API_URL || 'http://localhost:8000/api/v1';
---

<div id="content-card" class="content-card card" data-api-url={apiUrl}>
  <!-- Tab Navigation -->
  <div class="tabs-nav">
    <button class="tab-btn active" data-tab="articles">Articles</button>
    <button class="tab-btn" data-tab="co-mentions">Co-mentions</button>
    <button class="tab-btn" data-tab="tweets">Tweets</button>
    <button class="tab-btn" data-tab="reddit">Reddit</button>
  </div>

  <!-- Tab Content -->
  <div class="tabs-content">
    <!-- Articles Tab -->
    <div id="articles-tab" class="tab-content active">
      <div id="articles-loading" class="loading-skeleton">
        <div class="skeleton-item"></div>
        <div class="skeleton-item"></div>
        <div class="skeleton-item"></div>
      </div>
      <div id="articles-content" class="hidden">
        <div id="articles-list" class="content-list"></div>
      </div>
      <div id="articles-empty" class="empty-state hidden">
        No articles found
      </div>
    </div>

    <!-- Co-mentions Tab -->
    <div id="co-mentions-tab" class="tab-content hidden">
      <div id="co-mentions-loading" class="loading-skeleton">
        <div class="skeleton-item"></div>
        <div class="skeleton-item"></div>
        <div class="skeleton-item"></div>
      </div>
      <div id="co-mentions-content" class="hidden">
        <div id="co-mentions-list" class="content-list"></div>
      </div>
      <div id="co-mentions-empty" class="empty-state hidden">
        No co-mentions found
      </div>
    </div>

    <!-- Tweets Tab -->
    <div id="tweets-tab" class="tab-content hidden">
      <div id="tweets-loading" class="loading-skeleton">
        <div class="skeleton-item"></div>
        <div class="skeleton-item"></div>
        <div class="skeleton-item"></div>
      </div>
      <div id="tweets-content" class="hidden">
        <div id="tweets-list" class="content-list"></div>
      </div>
      <div id="tweets-empty" class="empty-state hidden">
        No tweets found
      </div>
    </div>

    <!-- Reddit Tab -->
    <div id="reddit-tab" class="tab-content hidden">
      <div id="reddit-loading" class="loading-skeleton">
        <div class="skeleton-item"></div>
        <div class="skeleton-item"></div>
        <div class="skeleton-item"></div>
      </div>
      <div id="reddit-content" class="hidden">
        <div id="reddit-list" class="content-list"></div>
      </div>
      <div id="reddit-empty" class="empty-state hidden">
        No Reddit posts found
      </div>
    </div>
  </div>
</div>

<style scoped>
  .content-card {
    width: 100%;
    max-width: 600px;
    padding: 0;
    display: flex;
    flex-direction: column;
  }

  .tabs-nav {
    display: flex;
    border-bottom: 1px solid #e8e4db;
    background-color: transparent;
  }

  :global(.dark) .tabs-nav {
    border-bottom-color: #3e3e3e;
  }

  .tab-btn {
    flex: 1;
    padding: 1rem;
    background: none;
    border: none;
    color: #7a7a7a;
    font-weight: 500;
    font-size: 0.9rem;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s ease;
  }

  :global(.dark) .tab-btn {
    color: #a0a0a0;
  }

  .tab-btn:hover {
    color: #3d3d3d;
  }

  :global(.dark) .tab-btn:hover {
    color: #e8e8e8;
  }

  .tab-btn.active {
    color: #3d3d3d;
    border-bottom-color: #d4a574;
  }

  :global(.dark) .tab-btn.active {
    color: #e8e8e8;
    border-bottom-color: #d4a574;
  }

  .tabs-content {
    padding: 2rem;
  }

  .tab-content {
    display: none;
  }

  .tab-content.active {
    display: block;
  }

  .loading-skeleton {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .skeleton-item {
    height: 80px;
    border-radius: 6px;
    background-color: #e8e4db;
    animation: pulse 2s ease-in-out infinite;
  }

  :global(.dark) .skeleton-item {
    background-color: #3e3e3e;
  }

  @keyframes pulse {
    0%, 100% {
      opacity: 1;
    }
    50% {
      opacity: 0.5;
    }
  }

  .content-list {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .content-item {
    padding-bottom: 1.5rem;
    border-bottom: 1px solid #e8e4db;
  }

  :global(.dark) .content-item {
    border-bottom-color: #3e3e3e;
  }

  .content-item:last-child {
    border-bottom: none;
  }

  .content-title {
    font-weight: 600;
    color: #3d3d3d;
    margin: 0 0 0.5rem 0;
    line-height: 1.4;
    font-size: 0.95rem;
  }

  :global(.dark) .content-title {
    color: #e8e8e8;
  }

  .content-title a {
    color: inherit;
    text-decoration: none;
    transition: color 0.2s ease;
  }

  .content-title a:hover {
    color: #d4a574;
  }

  .content-meta {
    font-size: 0.8rem;
    color: #7a7a7a;
    margin-top: 0.5rem;
  }

  :global(.dark) .content-meta {
    color: #a0a0a0;
  }

  .content-excerpt {
    font-size: 0.85rem;
    color: #7a7a7a;
    line-height: 1.5;
    margin-top: 0.5rem;
  }

  :global(.dark) .content-excerpt {
    color: #a0a0a0;
  }

  .empty-state {
    text-align: center;
    padding: 2rem;
    color: #7a7a7a;
  }

  :global(.dark) .empty-state {
    color: #a0a0a0;
  }

  .hidden {
    display: none;
  }

  /* Co-mentions specific styles */
  .co-mention-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .co-mention-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
  }

  .co-mention-name {
    font-weight: 600;
    color: #3d3d3d;
    text-decoration: none;
    transition: color 0.2s ease;
  }

  :global(.dark) .co-mention-name {
    color: #e8e8e8;
  }

  .co-mention-name:hover {
    color: #d4a574;
  }

  .co-mention-count {
    font-size: 0.8rem;
    font-weight: 500;
    color: #fff;
    background-color: #d4a574;
    padding: 0.2rem 0.6rem;
    border-radius: 12px;
    white-space: nowrap;
  }

  :global(.dark) .co-mention-count {
    background-color: #b8956a;
  }
</style>

<script>
  interface Article {
    title?: string;
    link?: string;
    source?: string;
    pub_date?: string;
  }

  interface CoMention {
    entity_type: string;
    entity_id: number;
    name: string;
    mention_count: number;
  }

  class ContentCard {
    private card: HTMLElement | null = null;
    private apiUrl = '';
    private sport: string | null = null;
    private type: string | null = null;
    private id: string | null = null;

    // Articles tab elements
    private loadingEl: HTMLElement | null = null;
    private contentEl: HTMLElement | null = null;
    private listEl: HTMLElement | null = null;
    private emptyEl: HTMLElement | null = null;

    // Co-mentions tab elements
    private coMentionsLoadingEl: HTMLElement | null = null;
    private coMentionsContentEl: HTMLElement | null = null;
    private coMentionsListEl: HTMLElement | null = null;
    private coMentionsEmptyEl: HTMLElement | null = null;
    private coMentionsLoaded = false;

    constructor() {
      const card = document.getElementById('content-card');
      if (!card) return;

      this.card = card;
      this.apiUrl = card.dataset.apiUrl || 'http://localhost:8000/api/v1';

      const params = new URLSearchParams(window.location.search);
      this.sport = params.get('sport');
      this.type = params.get('type');
      this.id = params.get('id');

      this.loadingEl = document.getElementById('articles-loading');
      this.contentEl = document.getElementById('articles-content');
      this.listEl = document.getElementById('articles-list');
      this.emptyEl = document.getElementById('articles-empty');

      // Initialize co-mentions elements
      this.coMentionsLoadingEl = document.getElementById('co-mentions-loading');
      this.coMentionsContentEl = document.getElementById('co-mentions-content');
      this.coMentionsListEl = document.getElementById('co-mentions-list');
      this.coMentionsEmptyEl = document.getElementById('co-mentions-empty');

      this.init();
    }

    private init() {
      this.bindTabEvents();

      if (!this.sport || !this.type || !this.id) {
        this.showEmpty();
        return;
      }

      this.fetchData();
    }

    private bindTabEvents() {
      if (!this.card) return;
      this.card.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const target = e.currentTarget as HTMLButtonElement;
          const tab = target.dataset.tab;

          this.card!.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          target.classList.add('active');

          this.card!.querySelectorAll('.tab-content').forEach(p => p.classList.remove('active'));
          const panel = document.getElementById(`${tab}-tab`);
          if (panel) panel.classList.add('active');

          // Lazy-load co-mentions when tab is clicked
          if (tab === 'co-mentions' && !this.coMentionsLoaded) {
            this.fetchCoMentions();
          }
        });
      });
    }

    private async fetchData() {
      const widgetUrl = `${this.apiUrl}/widget/${this.type}/${this.id}?sport=${this.sport!.toUpperCase()}`;
      console.log('[ContentCard] Fetching widget for name:', widgetUrl);

      try {
        const widgetRes = await fetch(widgetUrl);
        if (!widgetRes.ok) throw new Error(`Widget HTTP ${widgetRes.status}`);
        const widgetData = await widgetRes.json();

        const entityName = widgetData.team?.name || widgetData.player?.name || widgetData.name;
        if (!entityName) {
          this.showEmpty();
          return;
        }

        const newsUrl = `${this.apiUrl}/news/${encodeURIComponent(entityName)}`;
        console.log('[ContentCard] Fetching news:', newsUrl);

        const newsRes = await fetch(newsUrl);
        console.log('[ContentCard] News response status:', newsRes.status);
        if (!newsRes.ok) throw new Error(`News HTTP ${newsRes.status}`);

        const data = await newsRes.json();
        console.log('[ContentCard] News data:', data);

        const articles: Article[] = data.articles || [];
        if (articles.length === 0) {
          this.showEmpty();
          return;
        }

        this.renderArticles(articles);
      } catch (err) {
        console.error('[ContentCard] Error:', err);
        this.showEmpty();
      }
    }

    private renderArticles(articles: Article[]) {
      const html = articles.map(article => this.renderArticle(article)).join('');
      if (this.listEl) this.listEl.innerHTML = html;
      this.showContent();
    }

    private renderArticle(article: Article): string {
      const title = this.escapeHtml(article.title || 'Untitled');
      const link = article.link || '#';
      const source = this.escapeHtml(article.source || '');
      const date = this.formatDate(article.pub_date);

      return `<div class="content-item">
        <h3 class="content-title">
          <a href="${link}" target="_blank" rel="noopener">${title}</a>
        </h3>
        <div class="content-meta">${source}${source && date ? ' Â· ' : ''}${date}</div>
      </div>`;
    }

    private escapeHtml(str: string): string {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    private formatDate(dateStr?: string): string {
      if (!dateStr) return '';
      try {
        const d = new Date(dateStr);
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      } catch {
        return '';
      }
    }

    private showContent() {
      this.loadingEl?.classList.add('hidden');
      this.contentEl?.classList.remove('hidden');
      this.emptyEl?.classList.add('hidden');
    }

    private showEmpty() {
      this.loadingEl?.classList.add('hidden');
      this.contentEl?.classList.add('hidden');
      this.emptyEl?.classList.remove('hidden');
    }

    // Co-mentions methods
    private async fetchCoMentions() {
      if (!this.sport || !this.type || !this.id) {
        this.showCoMentionsEmpty();
        return;
      }

      const url = `${this.apiUrl}/co-mentions/${this.type}/${this.id}?sport=${this.sport.toUpperCase()}`;
      console.log('[ContentCard] Fetching co-mentions:', url);

      try {
        const res = await fetch(url);
        console.log('[ContentCard] Co-mentions response status:', res.status);
        if (!res.ok) throw new Error(`Co-mentions HTTP ${res.status}`);

        const data = await res.json();
        console.log('[ContentCard] Co-mentions data:', data);

        const coMentions: CoMention[] = data.co_mentions || [];
        this.coMentionsLoaded = true;

        if (coMentions.length === 0) {
          this.showCoMentionsEmpty();
          return;
        }

        this.renderCoMentions(coMentions);
      } catch (err) {
        console.error('[ContentCard] Co-mentions error:', err);
        this.showCoMentionsEmpty();
      }
    }

    private renderCoMentions(coMentions: CoMention[]) {
      const html = coMentions.map(cm => this.renderCoMention(cm)).join('');
      if (this.coMentionsListEl) this.coMentionsListEl.innerHTML = html;
      this.showCoMentionsContent();
    }

    private renderCoMention(cm: CoMention): string {
      const name = this.escapeHtml(cm.name);
      const type = cm.entity_type === 'player' ? 'Player' : 'Team';
      const count = cm.mention_count;
      const countLabel = count === 1 ? 'mention' : 'mentions';

      // Build link to the entity's mentions page
      const link = `/mentions?sport=${this.sport}&type=${cm.entity_type}&id=${cm.entity_id}`;

      return `<div class="content-item co-mention-item">
        <div class="co-mention-header">
          <a href="${link}" class="co-mention-name">${name}</a>
          <span class="co-mention-count">${count} ${countLabel}</span>
        </div>
        <div class="content-meta">${type}</div>
      </div>`;
    }

    private showCoMentionsContent() {
      this.coMentionsLoadingEl?.classList.add('hidden');
      this.coMentionsContentEl?.classList.remove('hidden');
      this.coMentionsEmptyEl?.classList.add('hidden');
    }

    private showCoMentionsEmpty() {
      this.coMentionsLoadingEl?.classList.add('hidden');
      this.coMentionsContentEl?.classList.add('hidden');
      this.coMentionsEmptyEl?.classList.remove('hidden');
    }
  }

  new ContentCard();
</script>
