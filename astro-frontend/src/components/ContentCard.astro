---
/**
 * Content Card with 4 Tabs
 * 
 * Displays content for an entity across 4 tabs:
 * - Articles
 * - Co-mentions
 * - Tweets
 * - Reddit
 * 
 * Used on the mentions page below the entity widget
 * Tab content is populated from the backend API
 */

// Get API URL at build time and pass to client
const apiUrl = import.meta.env.PUBLIC_API_URL || 'http://localhost:8000/api/v1';
---

<div id="content-card" class="content-card card" data-api-url={apiUrl}>
  <!-- Tab Navigation -->
  <div class="tabs-nav">
    <button class="tab-btn active" data-tab="articles">Articles</button>
    <button class="tab-btn" data-tab="co-mentions">Co-mentions</button>
    <button class="tab-btn" data-tab="tweets">Tweets</button>
    <button class="tab-btn" data-tab="reddit">Reddit</button>
  </div>

  <!-- Tab Content -->
  <div class="tabs-content">
    <!-- Articles Tab -->
    <div id="articles-tab" class="tab-content active">
      <div id="articles-loading" class="loading-skeleton">
        <div class="skeleton-item"></div>
        <div class="skeleton-item"></div>
        <div class="skeleton-item"></div>
      </div>
      <div id="articles-content" class="hidden">
        <div id="articles-list" class="content-list"></div>
      </div>
      <div id="articles-empty" class="empty-state hidden">
        No articles found
      </div>
    </div>

    <!-- Co-mentions Tab -->
    <div id="co-mentions-tab" class="tab-content">
      <div id="co-mentions-loading" class="loading-skeleton">
        <div class="skeleton-item"></div>
        <div class="skeleton-item"></div>
        <div class="skeleton-item"></div>
      </div>
      <div id="co-mentions-content" class="hidden">
        <div id="co-mentions-list" class="content-list"></div>
      </div>
      <div id="co-mentions-empty" class="empty-state hidden">
        No co-mentions found
      </div>
    </div>

    <!-- Tweets Tab -->
    <div id="tweets-tab" class="tab-content">
      <div id="tweets-loading" class="loading-skeleton">
        <div class="skeleton-item"></div>
        <div class="skeleton-item"></div>
        <div class="skeleton-item"></div>
      </div>
      <div id="tweets-content" class="hidden">
        <div id="tweets-list" class="content-list"></div>
      </div>
      <div id="tweets-empty" class="empty-state hidden">
        No tweets found
      </div>
    </div>

    <!-- Reddit Tab -->
    <div id="reddit-tab" class="tab-content">
      <div id="reddit-loading" class="loading-skeleton">
        <div class="skeleton-item"></div>
        <div class="skeleton-item"></div>
        <div class="skeleton-item"></div>
      </div>
      <div id="reddit-content" class="hidden">
        <div id="reddit-list" class="content-list"></div>
      </div>
      <div id="reddit-empty" class="empty-state hidden">
        No Reddit posts found
      </div>
    </div>
  </div>
</div>

<style scoped>
  .content-card {
    width: 100%;
    max-width: 600px;
    padding: 0;
    display: flex;
    flex-direction: column;
    border-radius: 0.375rem;
  }

  .tabs-nav {
    display: flex;
    border-bottom: 1px solid var(--border);
    background-color: transparent;
  }

  :global(.dark) .tabs-nav {
    border-bottom-color: var(--border-dark);
  }

  .tab-btn {
    flex: 1;
    padding: 0.875rem 0.5rem;
    min-height: 48px;
    background: none;
    border: none;
    color: var(--text-secondary);
    font-weight: 500;
    font-size: 0.9rem;
    cursor: pointer;
    border-bottom: 2px solid transparent;
  }

  :global(.dark) .tab-btn {
    color: var(--text-secondary-dark);
  }

  .tab-btn.active {
    color: var(--text);
    border-bottom-color: var(--text);
  }

  :global(.dark) .tab-btn.active {
    color: var(--text-dark);
    border-bottom-color: var(--text-dark);
  }

  .tabs-content {
    padding: 1.5rem;
  }

  .tab-content {
    display: none;
  }

  .tab-content.active {
    display: block;
  }

  .loading-skeleton {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .skeleton-item {
    height: 80px;
    border-radius: 4px;
    background-color: var(--border);
    animation: pulse 2s ease-in-out infinite;
  }

  :global(.dark) .skeleton-item {
    background-color: var(--border-dark);
  }

  @keyframes pulse {
    0%, 100% {
      opacity: 1;
    }
    50% {
      opacity: 0.5;
    }
  }

  .content-list {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .content-item {
    padding-bottom: 1.5rem;
    border-bottom: 1px solid var(--border);
  }

  :global(.dark) .content-item {
    border-bottom-color: var(--border-dark);
  }

  .content-item:last-child {
    border-bottom: none;
  }

  .content-title {
    font-weight: 600;
    color: var(--text);
    margin: 0 0 0.5rem 0;
    line-height: 1.4;
    font-size: 0.95rem;
  }

  :global(.dark) .content-title {
    color: var(--text-dark);
  }

  .content-title a {
    color: inherit;
    text-decoration: underline;
    text-decoration-color: var(--text-tertiary);
    text-underline-offset: 2px;
  }

  :global(.dark) .content-title a {
    text-decoration-color: var(--text-tertiary-dark);
  }

  .content-meta {
    font-size: 0.8rem;
    color: var(--text-secondary);
    margin-top: 0.5rem;
  }

  :global(.dark) .content-meta {
    color: var(--text-secondary-dark);
  }

  .content-excerpt {
    font-size: 0.85rem;
    color: var(--text-secondary);
    line-height: 1.5;
    margin-top: 0.5rem;
  }

  :global(.dark) .content-excerpt {
    color: var(--text-secondary-dark);
  }

  .empty-state {
    text-align: center;
    padding: 2rem;
    color: var(--text-secondary);
  }

  :global(.dark) .empty-state {
    color: var(--text-secondary-dark);
  }

  .hidden {
    display: none;
  }

  /* Co-mentions specific styles */
  .co-mention-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .co-mention-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
  }

  .co-mention-name {
    font-weight: 600;
    color: var(--text);
    text-decoration: underline;
    text-decoration-color: var(--text-tertiary);
    text-underline-offset: 2px;
  }

  :global(.dark) .co-mention-name {
    color: var(--text-dark);
    text-decoration-color: var(--text-tertiary-dark);
  }

  .co-mention-count {
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--text-secondary);
    background-color: var(--border);
    padding: 0.2rem 0.5rem;
    border-radius: 2px;
    white-space: nowrap;
  }

  :global(.dark) .co-mention-count {
    color: var(--text-secondary-dark);
    background-color: var(--border-dark);
  }

  /* Responsive - Mobile */
  @media (max-width: 480px) {
    .tabs-nav {
      gap: 0;
    }

    .tab-btn {
      padding: 0.75rem 0.25rem;
      font-size: 0.8rem;
    }

    .tabs-content {
      padding: 1rem;
    }

    .content-title {
      font-size: 0.9rem;
    }

    .content-excerpt {
      font-size: 0.8rem;
    }
  }

  /* Extra small screens */
  @media (max-width: 320px) {
    .tab-btn {
      font-size: 0.75rem;
      padding: 0.75rem 0.125rem;
    }

    .tabs-content {
      padding: 0.75rem;
    }
  }
</style>

<script>
  import { escapeHtml, parseEntityParams } from '../lib/utils/dom';
  import {
    findCoMentions,
    loadEntitiesForSport,
    type Article,
    type CoMention,
  } from '../lib/utils/co-mentions';

  // Extended article interface for rendering
  interface ArticleDisplay {
    title?: string;
    link?: string;
    source?: string;
    pub_date?: string;
  }

  class ContentCard {
    private card: HTMLElement | null = null;
    private apiUrl = '';
    private sport: string | null = null;
    private type: string | null = null;
    private id: string | null = null;

    // Store articles for co-mentions
    private articles: Article[] = [];

    // Articles tab elements
    private loadingEl: HTMLElement | null = null;
    private contentEl: HTMLElement | null = null;
    private listEl: HTMLElement | null = null;
    private emptyEl: HTMLElement | null = null;

    // Co-mentions tab elements
    private coMentionsLoadingEl: HTMLElement | null = null;
    private coMentionsContentEl: HTMLElement | null = null;
    private coMentionsListEl: HTMLElement | null = null;
    private coMentionsEmptyEl: HTMLElement | null = null;
    private coMentionsLoaded = false;

    constructor() {
      const card = document.getElementById('content-card');
      if (!card) return;

      this.card = card;
      this.apiUrl = card.dataset.apiUrl || 'http://localhost:8000/api/v1';

      const params = parseEntityParams();
      this.sport = params.sport;
      this.type = params.type;
      this.id = params.id;

      this.loadingEl = document.getElementById('articles-loading');
      this.contentEl = document.getElementById('articles-content');
      this.listEl = document.getElementById('articles-list');
      this.emptyEl = document.getElementById('articles-empty');

      // Initialize co-mentions elements
      this.coMentionsLoadingEl = document.getElementById('co-mentions-loading');
      this.coMentionsContentEl = document.getElementById('co-mentions-content');
      this.coMentionsListEl = document.getElementById('co-mentions-list');
      this.coMentionsEmptyEl = document.getElementById('co-mentions-empty');

      this.init();
    }

    private init() {
      this.bindTabEvents();

      if (!this.sport || !this.type || !this.id) {
        this.showEmpty();
        return;
      }

      this.fetchData();
    }

    private bindTabEvents() {
      if (!this.card) return;
      this.card.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const target = e.currentTarget as HTMLButtonElement;
          const tab = target.dataset.tab;

          this.card!.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          target.classList.add('active');

          this.card!.querySelectorAll('.tab-content').forEach(p => p.classList.remove('active'));
          const panel = document.getElementById(`${tab}-tab`);
          if (panel) panel.classList.add('active');

          // Lazy-load co-mentions when tab is clicked
          if (tab === 'co-mentions' && !this.coMentionsLoaded) {
            this.fetchCoMentions();
          }
        });
      });
    }

    private async fetchData() {
      const widgetUrl = `${this.apiUrl}/widget/${this.type}/${this.id}?sport=${this.sport!.toUpperCase()}`;

      try {
        const widgetRes = await fetch(widgetUrl);
        if (!widgetRes.ok) throw new Error(`Widget HTTP ${widgetRes.status}`);
        const widgetData = await widgetRes.json();

        const entityName = widgetData.team?.name || widgetData.player?.name || widgetData.name;
        if (!entityName) {
          this.showEmpty();
          return;
        }

        const newsUrl = `${this.apiUrl}/news/${encodeURIComponent(entityName)}`;
        const newsRes = await fetch(newsUrl);
        if (!newsRes.ok) throw new Error(`News HTTP ${newsRes.status}`);

        const data = await newsRes.json();
        const articles: ArticleDisplay[] = data.articles || [];

        // Store articles for co-mentions (with required Article shape)
        this.articles = articles.map(a => ({
          title: a.title || '',
          link: a.link || '',
          pub_date: a.pub_date,
          source: a.source,
        }));

        if (articles.length === 0) {
          this.showEmpty();
          return;
        }

        this.renderArticles(articles);
      } catch {
        this.showEmpty();
      }
    }

    private renderArticles(articles: ArticleDisplay[]) {
      const html = articles.map(article => this.renderArticle(article)).join('');
      if (this.listEl) this.listEl.innerHTML = html;
      this.showContent();
    }

    private renderArticle(article: ArticleDisplay): string {
      const title = escapeHtml(article.title || 'Untitled');
      const link = article.link || '#';
      const source = escapeHtml(article.source || '');
      const date = this.formatDate(article.pub_date);

      return `<div class="content-item">
        <h3 class="content-title">
          <a href="${link}" target="_blank" rel="noopener">${title}</a>
        </h3>
        <div class="content-meta">${source}${source && date ? ' Â· ' : ''}${date}</div>
      </div>`;
    }

    private formatDate(dateStr?: string): string {
      if (!dateStr) return '';
      try {
        const d = new Date(dateStr);
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      } catch {
        return '';
      }
    }

    private showContent() {
      this.loadingEl?.classList.add('hidden');
      this.contentEl?.classList.remove('hidden');
      this.emptyEl?.classList.add('hidden');
    }

    private showEmpty() {
      this.loadingEl?.classList.add('hidden');
      this.contentEl?.classList.add('hidden');
      this.emptyEl?.classList.remove('hidden');
    }

    // Co-mentions methods - now using frontend logic
    private async fetchCoMentions() {
      if (!this.sport || !this.type || !this.id) {
        this.showCoMentionsEmpty();
        return;
      }

      // If we don't have articles yet, we can't find co-mentions
      if (this.articles.length === 0) {
        this.showCoMentionsEmpty();
        return;
      }

      try {
        // Load all entities for this sport from static JSON
        const entities = await loadEntitiesForSport(this.sport);

        // Find co-mentions using frontend logic (2-part name matching)
        const coMentions = findCoMentions(
          this.articles,
          entities,
          this.id,
          this.type as 'player' | 'team'
        );

        this.coMentionsLoaded = true;

        if (coMentions.length === 0) {
          this.showCoMentionsEmpty();
          return;
        }

        this.renderCoMentions(coMentions);
      } catch (err) {
        console.error('Co-mentions error:', err);
        this.showCoMentionsEmpty();
      }
    }

    private renderCoMentions(coMentions: CoMention[]) {
      const html = coMentions.map(cm => this.renderCoMention(cm)).join('');
      if (this.coMentionsListEl) this.coMentionsListEl.innerHTML = html;
      this.showCoMentionsContent();
    }

    private renderCoMention(cm: CoMention): string {
      const name = escapeHtml(cm.entity.name);
      const type = cm.entity.type === 'player' ? 'Player' : 'Team';
      const count = cm.mentionCount;
      const countLabel = count === 1 ? 'mention' : 'mentions';

      // Build link to the co-mentions comparison page
      const link = `/co-mentions?sport=${this.sport}&type=${this.type}&id=${this.id}&coType=${cm.entity.type}&coId=${cm.entity.id}`;

      return `<div class="content-item co-mention-item">
        <div class="co-mention-header">
          <a href="${link}" class="co-mention-name">${name}</a>
          <span class="co-mention-count">${count} ${countLabel}</span>
        </div>
        <div class="content-meta">${type}</div>
      </div>`;
    }

    private showCoMentionsContent() {
      this.coMentionsLoadingEl?.classList.add('hidden');
      this.coMentionsContentEl?.classList.remove('hidden');
      this.coMentionsEmptyEl?.classList.add('hidden');
    }

    private showCoMentionsEmpty() {
      this.coMentionsLoadingEl?.classList.add('hidden');
      this.coMentionsContentEl?.classList.add('hidden');
      this.coMentionsEmptyEl?.classList.remove('hidden');
    }
  }

  new ContentCard();
</script>
