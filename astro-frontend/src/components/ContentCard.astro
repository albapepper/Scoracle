---
/**
 * Content Card with 4 Tabs
 * 
 * Displays content for an entity across 4 tabs:
 * - Articles
 * - Co-mentions
 * - Tweets
 * - Reddit
 * 
 * Used on the mentions page below the entity widget
 * Tab content is populated from the backend API
 */

// Get API URL at build time and pass to client
const apiUrl = import.meta.env.PUBLIC_API_URL || 'http://localhost:8000/api/v1';
---

<div id="content-card" class="content-card card" data-api-url={apiUrl}>
  <!-- Tab Navigation -->
  <div class="tabs-nav">
    <button class="tab-btn active" data-tab="articles">Articles</button>
    <button class="tab-btn" data-tab="co-mentions">Co-mentions</button>
    <button class="tab-btn" data-tab="tweets">Tweets</button>
    <button class="tab-btn" data-tab="reddit">Reddit</button>
  </div>

  <!-- Tab Content -->
  <div class="tabs-content">
    <!-- Articles Tab -->
    <div id="articles-tab" class="tab-content active">
      <div id="articles-loading" class="loading-skeleton">
        <div class="skeleton-item"></div>
        <div class="skeleton-item"></div>
        <div class="skeleton-item"></div>
      </div>
      <div id="articles-content" class="hidden">
        <div id="articles-list" class="content-list"></div>
      </div>
      <div id="articles-empty" class="empty-state hidden">
        No articles found
      </div>
    </div>

    <!-- Co-mentions Tab -->
    <div id="co-mentions-tab" class="tab-content hidden">
      <div id="co-mentions-loading" class="loading-skeleton">
        <div class="skeleton-item"></div>
        <div class="skeleton-item"></div>
        <div class="skeleton-item"></div>
      </div>
      <div id="co-mentions-content" class="hidden">
        <div id="co-mentions-list" class="content-list"></div>
      </div>
      <div id="co-mentions-empty" class="empty-state hidden">
        No co-mentions found
      </div>
    </div>

    <!-- Tweets Tab -->
    <div id="tweets-tab" class="tab-content hidden">
      <div id="tweets-loading" class="loading-skeleton">
        <div class="skeleton-item"></div>
        <div class="skeleton-item"></div>
        <div class="skeleton-item"></div>
      </div>
      <div id="tweets-content" class="hidden">
        <div id="tweets-list" class="content-list"></div>
      </div>
      <div id="tweets-empty" class="empty-state hidden">
        No tweets found
      </div>
    </div>

    <!-- Reddit Tab -->
    <div id="reddit-tab" class="tab-content hidden">
      <div id="reddit-loading" class="loading-skeleton">
        <div class="skeleton-item"></div>
        <div class="skeleton-item"></div>
        <div class="skeleton-item"></div>
      </div>
      <div id="reddit-content" class="hidden">
        <div id="reddit-list" class="content-list"></div>
      </div>
      <div id="reddit-empty" class="empty-state hidden">
        No Reddit posts found
      </div>
    </div>
  </div>
</div>

<style scoped>
  .content-card {
    width: 100%;
    max-width: 600px;
    padding: 0;
    display: flex;
    flex-direction: column;
  }

  .tabs-nav {
    display: flex;
    border-bottom: 1px solid #e8e4db;
    background-color: transparent;
  }

  :global(.dark) .tabs-nav {
    border-bottom-color: #3e3e3e;
  }

  .tab-btn {
    flex: 1;
    padding: 1rem;
    background: none;
    border: none;
    color: #7a7a7a;
    font-weight: 500;
    font-size: 0.9rem;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s ease;
  }

  :global(.dark) .tab-btn {
    color: #a0a0a0;
  }

  .tab-btn:hover {
    color: #3d3d3d;
  }

  :global(.dark) .tab-btn:hover {
    color: #e8e8e8;
  }

  .tab-btn.active {
    color: #3d3d3d;
    border-bottom-color: #d4a574;
  }

  :global(.dark) .tab-btn.active {
    color: #e8e8e8;
    border-bottom-color: #d4a574;
  }

  .tabs-content {
    padding: 2rem;
  }

  .tab-content {
    display: none;
  }

  .tab-content.active {
    display: block;
  }

  .loading-skeleton {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .skeleton-item {
    height: 80px;
    border-radius: 6px;
    background-color: #e8e4db;
    animation: pulse 2s ease-in-out infinite;
  }

  :global(.dark) .skeleton-item {
    background-color: #3e3e3e;
  }

  @keyframes pulse {
    0%, 100% {
      opacity: 1;
    }
    50% {
      opacity: 0.5;
    }
  }

  .content-list {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .content-item {
    padding-bottom: 1.5rem;
    border-bottom: 1px solid #e8e4db;
  }

  :global(.dark) .content-item {
    border-bottom-color: #3e3e3e;
  }

  .content-item:last-child {
    border-bottom: none;
  }

  .content-title {
    font-weight: 600;
    color: #3d3d3d;
    margin: 0 0 0.5rem 0;
    line-height: 1.4;
    font-size: 0.95rem;
  }

  :global(.dark) .content-title {
    color: #e8e8e8;
  }

  .content-title a {
    color: inherit;
    text-decoration: none;
    transition: color 0.2s ease;
  }

  .content-title a:hover {
    color: #d4a574;
  }

  .content-meta {
    font-size: 0.8rem;
    color: #7a7a7a;
    margin-top: 0.5rem;
  }

  :global(.dark) .content-meta {
    color: #a0a0a0;
  }

  .content-excerpt {
    font-size: 0.85rem;
    color: #7a7a7a;
    line-height: 1.5;
    margin-top: 0.5rem;
  }

  :global(.dark) .content-excerpt {
    color: #a0a0a0;
  }

  .empty-state {
    text-align: center;
    padding: 2rem;
    color: #7a7a7a;
  }

  :global(.dark) .empty-state {
    color: #a0a0a0;
  }

  .hidden {
    display: none;
  }
</style>

<script>
  // Simple IIFE - plain JavaScript for maximum compatibility
  (function initContentCard() {
    const card = document.getElementById('content-card');
    if (!card) return;

    const apiUrl = card.getAttribute('data-api-url') || 'http://localhost:8000/api/v1';

    // Parse URL params
    const params = new URLSearchParams(window.location.search);
    const sport = params.get('sport');
    const type = params.get('type');
    const id = params.get('id');

    // Elements
    const loadingEl = document.getElementById('articles-loading');
    const contentEl = document.getElementById('articles-content');
    const listEl = document.getElementById('articles-list');
    const emptyEl = document.getElementById('articles-empty');

    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(function(btn) {
      btn.addEventListener('click', function() {
        const tab = this.getAttribute('data-tab');
        
        // Update buttons
        document.querySelectorAll('.tab-btn').forEach(function(b) {
          b.classList.remove('active');
        });
        this.classList.add('active');
        
        // Update panels
        document.querySelectorAll('.tab-content').forEach(function(p) {
          p.classList.remove('active');
        });
        const panel = document.getElementById(tab + '-tab');
        if (panel) panel.classList.add('active');
      });
    });

    // Validate params
    if (!sport || !type || !id) {
      showEmpty();
      return;
    }

    // Step 1: Get entity name from widget endpoint (cached for 30 days, so fast)
    // Step 2: Use entity name to fetch news
    var widgetUrl = apiUrl + '/widget/' + type + '/' + id + '?sport=' + sport.toUpperCase();
    console.log('[ContentCard] Fetching widget for name:', widgetUrl);

    fetch(widgetUrl)
      .then(function(res) {
        if (!res.ok) throw new Error('Widget HTTP ' + res.status);
        return res.json();
      })
      .then(function(widgetData) {
        // Get entity name from widget response
        var entityName = '';
        if (widgetData.team) {
          entityName = widgetData.team.name;
        } else if (widgetData.player) {
          entityName = widgetData.player.name;
        } else {
          entityName = widgetData.name;
        }
        
        if (!entityName) {
          showEmpty();
          return;
        }

        // Fetch news using entity name
        var newsUrl = apiUrl + '/news/' + encodeURIComponent(entityName);
        console.log('[ContentCard] Fetching news:', newsUrl);

        return fetch(newsUrl);
      })
      .then(function(res) {
        if (!res) return null;
        console.log('[ContentCard] News response status:', res.status);
        if (!res.ok) throw new Error('News HTTP ' + res.status);
        return res.json();
      })
      .then(function(data) {
        if (!data) return;
        console.log('[ContentCard] News data:', data);
        var articles = data.articles || [];
        
        if (articles.length === 0) {
          showEmpty();
          return;
        }

        // Render articles as simple HTML
        var html = '';
        for (var i = 0; i < articles.length; i++) {
          html += renderArticle(articles[i]);
        }
        listEl.innerHTML = html;
        showContent();
      })
      .catch(function(err) {
        console.error('[ContentCard] Error:', err);
        showEmpty();
      });

    function renderArticle(article) {
      var title = escapeHtml(article.title || 'Untitled');
      var link = article.link || '#';
      var source = escapeHtml(article.source || '');
      var date = formatDate(article.pub_date);
      
      return '<div class="content-item">' +
        '<h3 class="content-title">' +
          '<a href="' + link + '" target="_blank" rel="noopener">' + title + '</a>' +
        '</h3>' +
        '<div class="content-meta">' + source + (source && date ? ' Â· ' : '') + date + '</div>' +
      '</div>';
    }

    function escapeHtml(str) {
      if (!str) return '';
      var div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      try {
        var d = new Date(dateStr);
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      } catch (e) {
        return '';
      }
    }

    function showContent() {
      if (loadingEl) loadingEl.classList.add('hidden');
      if (contentEl) contentEl.classList.remove('hidden');
      if (emptyEl) emptyEl.classList.add('hidden');
    }

    function showEmpty() {
      if (loadingEl) loadingEl.classList.add('hidden');
      if (contentEl) contentEl.classList.add('hidden');
      if (emptyEl) emptyEl.classList.remove('hidden');
    }
  })();
</script>
