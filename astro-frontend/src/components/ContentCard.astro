---
/**
 * Content Card with 4 Tabs
 * 
 * Displays content for an entity across 4 tabs:
 * - Articles
 * - Co-mentions
 * - Tweets
 * - Reddit
 * 
 * Used on the mentions page below the entity widget
 * Tab content is populated from the backend API
 */
---

<div id="content-card" class="content-card card">
  <!-- Tab Navigation -->
  <div class="tabs-nav">
    <button class="tab-btn active" data-tab="articles">Articles</button>
    <button class="tab-btn" data-tab="co-mentions">Co-mentions</button>
    <button class="tab-btn" data-tab="tweets">Tweets</button>
    <button class="tab-btn" data-tab="reddit">Reddit</button>
  </div>

  <!-- Tab Content -->
  <div class="tabs-content">
    <!-- Articles Tab -->
    <div id="articles-tab" class="tab-content active">
      <div id="articles-loading" class="loading-skeleton">
        <div class="skeleton-item"></div>
        <div class="skeleton-item"></div>
        <div class="skeleton-item"></div>
      </div>
      <div id="articles-content" class="hidden">
        <div id="articles-list" class="content-list"></div>
      </div>
      <div id="articles-empty" class="empty-state hidden">
        No articles found
      </div>
    </div>

    <!-- Co-mentions Tab -->
    <div id="co-mentions-tab" class="tab-content hidden">
      <div id="co-mentions-loading" class="loading-skeleton">
        <div class="skeleton-item"></div>
        <div class="skeleton-item"></div>
        <div class="skeleton-item"></div>
      </div>
      <div id="co-mentions-content" class="hidden">
        <div id="co-mentions-list" class="content-list"></div>
      </div>
      <div id="co-mentions-empty" class="empty-state hidden">
        No co-mentions found
      </div>
    </div>

    <!-- Tweets Tab -->
    <div id="tweets-tab" class="tab-content hidden">
      <div id="tweets-loading" class="loading-skeleton">
        <div class="skeleton-item"></div>
        <div class="skeleton-item"></div>
        <div class="skeleton-item"></div>
      </div>
      <div id="tweets-content" class="hidden">
        <div id="tweets-list" class="content-list"></div>
      </div>
      <div id="tweets-empty" class="empty-state hidden">
        No tweets found
      </div>
    </div>

    <!-- Reddit Tab -->
    <div id="reddit-tab" class="tab-content hidden">
      <div id="reddit-loading" class="loading-skeleton">
        <div class="skeleton-item"></div>
        <div class="skeleton-item"></div>
        <div class="skeleton-item"></div>
      </div>
      <div id="reddit-content" class="hidden">
        <div id="reddit-list" class="content-list"></div>
      </div>
      <div id="reddit-empty" class="empty-state hidden">
        No Reddit posts found
      </div>
    </div>
  </div>
</div>

<style scoped>
  .content-card {
    width: 100%;
    max-width: 600px;
    padding: 0;
    display: flex;
    flex-direction: column;
  }

  .tabs-nav {
    display: flex;
    border-bottom: 1px solid #e8e4db;
    background-color: transparent;
  }

  :global(.dark) .tabs-nav {
    border-bottom-color: #3e3e3e;
  }

  .tab-btn {
    flex: 1;
    padding: 1rem;
    background: none;
    border: none;
    color: #7a7a7a;
    font-weight: 500;
    font-size: 0.9rem;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s ease;
  }

  :global(.dark) .tab-btn {
    color: #a0a0a0;
  }

  .tab-btn:hover {
    color: #3d3d3d;
  }

  :global(.dark) .tab-btn:hover {
    color: #e8e8e8;
  }

  .tab-btn.active {
    color: #3d3d3d;
    border-bottom-color: #d4a574;
  }

  :global(.dark) .tab-btn.active {
    color: #e8e8e8;
    border-bottom-color: #d4a574;
  }

  .tabs-content {
    padding: 2rem;
  }

  .tab-content {
    display: none;
  }

  .tab-content.active {
    display: block;
  }

  .loading-skeleton {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .skeleton-item {
    height: 80px;
    border-radius: 6px;
    background-color: #e8e4db;
    animation: pulse 2s ease-in-out infinite;
  }

  :global(.dark) .skeleton-item {
    background-color: #3e3e3e;
  }

  @keyframes pulse {
    0%, 100% {
      opacity: 1;
    }
    50% {
      opacity: 0.5;
    }
  }

  .content-list {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .content-item {
    padding-bottom: 1.5rem;
    border-bottom: 1px solid #e8e4db;
  }

  :global(.dark) .content-item {
    border-bottom-color: #3e3e3e;
  }

  .content-item:last-child {
    border-bottom: none;
  }

  .content-title {
    font-weight: 600;
    color: #3d3d3d;
    margin: 0 0 0.5rem 0;
    line-height: 1.4;
    font-size: 0.95rem;
  }

  :global(.dark) .content-title {
    color: #e8e8e8;
  }

  .content-title a {
    color: inherit;
    text-decoration: none;
    transition: color 0.2s ease;
  }

  .content-title a:hover {
    color: #d4a574;
  }

  .content-meta {
    font-size: 0.8rem;
    color: #7a7a7a;
    margin-top: 0.5rem;
  }

  :global(.dark) .content-meta {
    color: #a0a0a0;
  }

  .content-excerpt {
    font-size: 0.85rem;
    color: #7a7a7a;
    line-height: 1.5;
    margin-top: 0.5rem;
  }

  :global(.dark) .content-excerpt {
    color: #a0a0a0;
  }

  .empty-state {
    text-align: center;
    padding: 2rem;
    color: #7a7a7a;
  }

  :global(.dark) .empty-state {
    color: #a0a0a0;
  }

  .hidden {
    display: none;
  }
</style>

<script>
  class ContentCardManager {
    private sport: string | null;
    private entityType: string | null;
    private entityId: string | null;
    private currentTab: string = 'articles';

    constructor() {
      const params = new URLSearchParams(window.location.search);
      this.sport = params.get('sport');
      this.entityType = params.get('type');
      this.entityId = params.get('id');

      this.initTabs();

      if (this.sport && this.entityType && this.entityId) {
        this.loadTabContent('articles');
      }
    }

    private initTabs() {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const tab = (e.target as HTMLElement).getAttribute('data-tab');
          if (tab) this.switchTab(tab);
        });
      });
    }

    private switchTab(tabName: string) {
      // Update active button
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`[data-tab="${tabName}"]`)?.classList.add('active');

      // Update active content
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(`${tabName}-tab`)?.classList.add('active');

      // Load content if not already loaded
      this.currentTab = tabName;
      this.loadTabContent(tabName);
    }

    private async loadTabContent(tabName: string) {
      const loadingEl = document.getElementById(`${tabName}-loading`);
      const contentEl = document.getElementById(`${tabName}-content`);
      const emptyEl = document.getElementById(`${tabName}-empty`);
      const listEl = document.getElementById(`${tabName}-list`);

      if (!loadingEl || !contentEl || !emptyEl || !listEl) return;

      // Already loaded
      if (!loadingEl.classList.contains('hidden')) {
        try {
          const data = await this.fetchTabData(tabName);

          if (data && data.length > 0) {
            listEl.innerHTML = this.renderContent(tabName, data);
            loadingEl.classList.add('hidden');
            contentEl.classList.remove('hidden');
          } else {
            loadingEl.classList.add('hidden');
            emptyEl.classList.remove('hidden');
          }
        } catch (error) {
          console.error(`Error loading ${tabName}:`, error);
          loadingEl.classList.add('hidden');
          emptyEl.classList.remove('hidden');
        }
      }
    }

    private async fetchTabData(tabName: string) {
      const apiUrl = import.meta.env.PUBLIC_API_URL || 'http://localhost:8000/api/v1';
      const endpoint = this.getEndpoint(tabName);

      try {
        const response = await fetch(
          `${apiUrl}/${endpoint}?sport=${this.sport}&type=${this.entityType}&id=${this.entityId}`
        );

        if (!response.ok) return [];
        return await response.json();
      } catch {
        return [];
      }
    }

    private getEndpoint(tabName: string): string {
      switch (tabName) {
        case 'articles':
          return 'content/articles';
        case 'co-mentions':
          return 'content/co-mentions';
        case 'tweets':
          return 'content/tweets';
        case 'reddit':
          return 'content/reddit';
        default:
          return 'content/articles';
      }
    }

    private renderContent(tabName: string, items: any[]): string {
      return items
        .map(item => {
          switch (tabName) {
            case 'articles':
              return this.renderArticle(item);
            case 'co-mentions':
              return this.renderCoMention(item);
            case 'tweets':
              return this.renderTweet(item);
            case 'reddit':
              return this.renderReddit(item);
            default:
              return '';
          }
        })
        .join('');
    }

    private renderArticle(article: any): string {
      return `
        <div class="content-item">
          <h3 class="content-title">
            <a href="${this.esc(article.url)}" target="_blank" rel="noopener noreferrer">
              ${this.esc(article.title)}
            </a>
          </h3>
          <div class="content-meta">
            ${this.esc(article.source)} · ${this.formatDate(article.published_at)}
          </div>
          ${article.excerpt ? `<div class="content-excerpt">${this.esc(article.excerpt)}</div>` : ''}
        </div>
      `;
    }

    private renderCoMention(mention: any): string {
      return `
        <div class="content-item">
          <h3 class="content-title">
            <a href="?sport=${this.sport}&type=${mention.entity_type}&id=${mention.entity_id}">
              ${this.esc(mention.entity_name)}
            </a>
          </h3>
          <div class="content-meta">
            ${this.esc(mention.mentions_count)} mentions
          </div>
        </div>
      `;
    }

    private renderTweet(tweet: any): string {
      return `
        <div class="content-item">
          <h3 class="content-title">
            <a href="${this.esc(tweet.url)}" target="_blank" rel="noopener noreferrer">
              @${this.esc(tweet.author)}
            </a>
          </h3>
          <div class="content-excerpt">${this.esc(tweet.text)}</div>
          <div class="content-meta">
            ${this.formatDate(tweet.created_at)}
          </div>
        </div>
      `;
    }

    private renderReddit(post: any): string {
      return `
        <div class="content-item">
          <h3 class="content-title">
            <a href="${this.esc(post.url)}" target="_blank" rel="noopener noreferrer">
              ${this.esc(post.title)}
            </a>
          </h3>
          <div class="content-meta">
            r/${this.esc(post.subreddit)} · ${this.formatDate(post.created_at)}
          </div>
          ${post.excerpt ? `<div class="content-excerpt">${this.esc(post.excerpt)}</div>` : ''}
        </div>
      `;
    }

    private formatDate(dateStr: string): string {
      try {
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'short',
          day: 'numeric'
        });
      } catch {
        return dateStr;
      }
    }

    private esc(str: string): string {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }
  }

  new ContentCardManager();
</script>
