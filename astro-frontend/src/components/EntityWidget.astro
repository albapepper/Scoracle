---
/**
 * Basic Entity Widget - Reusable card for displaying entity information
 * 
 * Used on:
 * - Mentions page (top card) - shows "Statistical Profile" button
 * - Entity detail page (top card) - shows "Recent News" button
 * 
 * The widget automatically populates all content from the backend API
 * based on URL parameters (sport, type, id)
 * 
 * Props:
 * - page: 'mentions' | 'entity' - determines button text and destination
 */

interface Props {
  page?: 'mentions' | 'entity';
}

const { page = 'mentions' } = Astro.props;

const buttonText = page === 'mentions' ? 'Statistical Profile' : 'Recent News';
const buttonDestination = page === 'mentions' ? 'entity' : 'mentions';
---

<div id="entity-widget" class="entity-widget card" data-page={page} data-button-destination={buttonDestination}>
  <!-- Loading State -->
  <div id="entity-loading" class="entity-loading">
    <div class="skeleton-avatar"></div>
    <div class="skeleton-text"></div>
    <div class="skeleton-text" style="width: 60%;"></div>
  </div>

  <!-- Content State -->
  <div id="entity-content" class="entity-content hidden">
    <div class="entity-header">
      <h2 id="entity-name" class="entity-name"></h2>
      <span id="sport-badge" class="sport-badge"></span>
    </div>
    <p id="entity-description" class="entity-description"></p>
    <a id="entity-profile-link" href="#" class="profile-link">View Full Profile â†’</a>
  </div>

  <!-- Error State -->
  <div id="entity-error" class="entity-error hidden">
    <p>Unable to load entity information</p>
  </div>

  <!-- Button (persistent across all states) -->
  <a id="entity-button" href="#" class="stats-button">{buttonText}</a>
</div>

<style scoped>
  .entity-widget {
    width: 100%;
    max-width: 600px;
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .entity-loading {
    padding: 2rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
  }

  .skeleton-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background-color: #e8e4db;
    animation: pulse 2s ease-in-out infinite;
  }

  :global(.dark) .skeleton-avatar {
    background-color: #3e3e3e;
  }

  .skeleton-text {
    width: 100%;
    height: 12px;
    border-radius: 4px;
    background-color: #e8e4db;
    animation: pulse 2s ease-in-out infinite;
  }

  :global(.dark) .skeleton-text {
    background-color: #3e3e3e;
  }

  @keyframes pulse {
    0%, 100% {
      opacity: 1;
    }
    50% {
      opacity: 0.5;
    }
  }

  .entity-content {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    padding: 2rem;
  }

  .entity-header {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    align-items: center;
  }

  .entity-name {
    font-size: 1.5rem;
    font-weight: 700;
    color: #3d3d3d;
    margin: 0;
  }

  :global(.dark) .entity-name {
    color: #e8e8e8;
  }

  .sport-badge {
    display: inline-block;
    padding: 0.375rem 0.75rem;
    background-color: #d4a574;
    color: white;
    border-radius: 0.375rem;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .entity-description {
    font-size: 0.95rem;
    color: #7a7a7a;
    line-height: 1.6;
    margin: 0;
  }

  :global(.dark) .entity-description {
    color: #a0a0a0;
  }

  .profile-link {
    display: inline-block;
    font-size: 0.9rem;
    color: #d4a574;
    text-decoration: none;
    font-weight: 500;
    transition: all 0.2s ease;
  }

  .profile-link:hover {
    color: #c29560;
    transform: translateX(4px);
  }

  :global(.dark) .profile-link {
    color: #d4a574;
  }

  :global(.dark) .profile-link:hover {
    color: #e6c393;
  }

  .stats-button {
    display: inline-block;
    padding: 0.5rem 1rem;
    background-color: #d4a574;
    color: white;
    text-decoration: none;
    border-radius: 0.5rem;
    font-weight: 500;
    font-size: 0.9rem;
    transition: all 0.2s ease;
    border: 1px solid #d4a574;
    cursor: pointer;
    margin-top: 0.5rem;
  }

  .stats-button:hover {
    background-color: #c29560;
    border-color: #c29560;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(212, 165, 116, 0.3);
  }

  .stats-button:active {
    transform: translateY(0);
  }

  :global(.dark) .stats-button {
    background-color: #d4a574;
    color: white;
    border-color: #d4a574;
  }

  :global(.dark) .stats-button:hover {
    background-color: #e6c393;
    border-color: #e6c393;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(212, 165, 116, 0.3);
  }

  .entity-error {
    padding: 2rem;
    text-align: center;
    color: #7a7a7a;
    min-height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  :global(.dark) .entity-error {
    color: #a0a0a0;
  }

  .hidden {
    display: none;
  }
</style>

<script>
  class EntityWidgetManager {
    private entityId: string | null;
    private sport: string | null;
    private entityType: string | null;
    private buttonDestination: string | null;
    private loadingEl: HTMLElement;
    private contentEl: HTMLElement;
    private errorEl: HTMLElement;

    constructor() {
      const params = new URLSearchParams(window.location.search);
      this.sport = params.get('sport');
      this.entityType = params.get('type');
      this.entityId = params.get('id');

      const widgetEl = document.getElementById('entity-widget')!;
      this.buttonDestination = widgetEl.getAttribute('data-button-destination');

      this.loadingEl = document.getElementById('entity-loading')!;
      this.contentEl = document.getElementById('entity-content')!;
      this.errorEl = document.getElementById('entity-error')!;

      // Set button href on load (before content is fetched)
      this.setButtonHref();

      if (this.entityId && this.sport && this.entityType) {
        this.loadEntity();
      } else {
        this.showError();
      }
    }

    private setButtonHref() {
      const buttonEl = document.getElementById('entity-button') as HTMLAnchorElement;

      if (this.sport && this.entityType && this.entityId && buttonEl) {
        const href = this.buttonDestination === 'entity'
          ? `/entity?sport=${this.sport}&type=${this.entityType}&id=${this.entityId}`
          : `/mentions?sport=${this.sport}&type=${this.entityType}&id=${this.entityId}`;

        buttonEl.href = href;
      }
    }

    private async loadEntity() {
      try {
        const apiUrl = import.meta.env.PUBLIC_API_URL || 'http://localhost:8000/api/v1';
        const response = await fetch(
          `${apiUrl}/entities/${this.sport}/${this.entityType}/${this.entityId}`
        );

        if (!response.ok) throw new Error('Failed to load entity');

        const entity = await response.json();
        this.renderEntity(entity);
      } catch (error) {
        console.error('Error loading entity:', error);
        this.showError();
      }
    }

    private renderEntity(entity: any) {
      const nameEl = document.getElementById('entity-name')!;
      const badgeEl = document.getElementById('sport-badge')!;
      const descEl = document.getElementById('entity-description')!;
      const linkEl = document.getElementById('entity-profile-link') as HTMLAnchorElement;

      nameEl.textContent = entity.name || 'Unknown Entity';
      badgeEl.textContent = (this.entityType || '').toUpperCase();
      descEl.textContent = entity.description || '';
      linkEl.href = `/entity?sport=${this.sport}&type=${this.entityType}&id=${this.entityId}`;
      
      this.setButtonHref();

      this.loadingEl.classList.add('hidden');
      this.contentEl.classList.remove('hidden');
    }

    private showError() {
      this.loadingEl.classList.add('hidden');
      this.errorEl.classList.remove('hidden');
    }
  }

  new EntityWidgetManager();
</script>
