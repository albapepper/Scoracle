---
/**
 * Stats Content Card
 *
 * Primary content card for the stats page. Displays entity statistics
 * and related features in a tabbed interface.
 *
 * Tabs:
 * - Stats: Entity statistics with pizza chart visualization
 * - Similarity: Similar players/teams based on embeddings
 * - Predictions: LSTM-based performance predictions
 *
 * Props:
 * - title: Card title for the stats tab (defaults to "Statistics")
 * - showChart: Whether to show the pizza chart (defaults to true)
 */

import StatsTab from './tabs/StatsTab.astro';
import SimilarityTab from './tabs/SimilarityTab.astro';
import PredictionsTab from './tabs/PredictionsTab.astro';

interface Props {
  title?: string;
  showChart?: boolean;
}

const { title = 'Statistics', showChart = true } = Astro.props;
---

<div class="stats-content-card card">
  <!-- Tab Navigation -->
  <div class="tabs-nav">
    <button class="tab-btn active" data-tab="stats">Stats</button>
    <button class="tab-btn" data-tab="similarity">Similarity</button>
    <button class="tab-btn" data-tab="predictions">Predictions</button>
  </div>

  <!-- Tab Content -->
  <div class="tabs-content">
    <!-- Stats Tab -->
    <div id="stats-tab" class="tab-content active">
      <StatsTab title={title} showChart={showChart} />
    </div>

    <!-- Similarity Tab -->
    <div id="similarity-tab" class="tab-content">
      <SimilarityTab />
    </div>

    <!-- Predictions Tab -->
    <div id="predictions-tab" class="tab-content">
      <PredictionsTab />
    </div>
  </div>
</div>

<style>
  .stats-content-card {
    width: 100%;
    max-width: 600px;
    display: flex;
    flex-direction: column;
    border-radius: 0.375rem;
    overflow: hidden;
  }

  /* Tab Navigation */
  .tabs-nav {
    display: flex;
    border-bottom: 1px solid var(--border);
    background-color: transparent;
  }

  :global(.dark) .tabs-nav {
    border-bottom-color: var(--border-dark);
  }

  .tab-btn {
    flex: 1;
    padding: 0.875rem 0.5rem;
    min-height: 48px;
    background: none;
    border: none;
    color: var(--text-secondary);
    font-weight: 500;
    font-size: 0.9rem;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: color 0.15s, border-color 0.15s;
  }

  :global(.dark) .tab-btn {
    color: var(--text-secondary-dark);
  }

  .tab-btn:hover {
    color: var(--text);
  }

  :global(.dark) .tab-btn:hover {
    color: var(--text-dark);
  }

  .tab-btn.active {
    color: var(--text);
    border-bottom-color: var(--text);
  }

  :global(.dark) .tab-btn.active {
    color: var(--text-dark);
    border-bottom-color: var(--text-dark);
  }

  .tabs-content {
    min-height: 300px;
  }

  .tab-content {
    display: none;
  }

  .tab-content.active {
    display: block;
  }

  /* Responsive - Mobile */
  @media (max-width: 480px) {
    .tabs-nav {
      gap: 0;
    }

    .tab-btn {
      padding: 0.75rem 0.25rem;
      font-size: 0.8rem;
    }
  }

  /* Extra small screens */
  @media (max-width: 320px) {
    .tab-btn {
      font-size: 0.75rem;
      padding: 0.75rem 0.125rem;
    }
  }
</style>

<script>
  /**
   * Tab Navigation Handler
   *
   * Manages tab switching and lazy loading of tab content.
   */
  class StatsContentCardManager {
    private card: HTMLElement;

    constructor(card: HTMLElement) {
      this.card = card;
      this.bindTabEvents();
    }

    private bindTabEvents() {
      this.card.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const target = e.currentTarget as HTMLButtonElement;
          const tab = target.dataset.tab;

          // Update active tab button
          this.card.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          target.classList.add('active');

          // Update active tab content
          this.card.querySelectorAll('.tab-content').forEach(p => p.classList.remove('active'));
          const panel = this.card.querySelector(`#${tab}-tab`);
          if (panel) panel.classList.add('active');

          // Lazy-load tab content
          if (tab === 'stats') {
            (window as any).statsTab?.load();
          }
          if (tab === 'similarity') {
            (window as any).similarityTab?.load();
          }
          if (tab === 'predictions') {
            (window as any).predictionsTab?.load();
          }
        });
      });
    }
  }

  // Initialize on page load
  const statsContentCard = document.querySelector<HTMLElement>('.stats-content-card');
  if (statsContentCard) {
    new StatsContentCardManager(statsContentCard);
  }
</script>
