---
/**
 * Profile Widget
 *
 * Displays entity profile information from the backend.
 * Fetches: GET /api/v1/widget/profile/{entity_type}/{entity_id}?sport={sport}
 *
 * Response structure:
 * {
 *   entity_id, entity_type, sport, season,
 *   info: { id, first_name, last_name, full_name, position, photo_url, team: { name, logo_url }, ... }
 * }
 */

interface Props {
  page?: 'news' | 'stats';
  showCompareButton?: boolean;
}

const { page = 'news', showCompareButton = false } = Astro.props;
const buttonText = page === 'news' ? 'View Stats' : 'View News';
const buttonDest = page === 'news' ? 'stats' : 'news';
const apiUrl = import.meta.env.PUBLIC_API_URL || 'http://localhost:8000/api/v1';
---

<div
  id="profile-widget"
  class="profile-widget card"
  data-api={apiUrl}
  data-dest={buttonDest}
  data-show-compare={showCompareButton ? 'true' : 'false'}
>
  <div class="pw-body">
    <!-- Loading -->
    <div id="pw-loading" class="pw-loading">
      <div class="skeleton-circle"></div>
      <div class="skeleton-line"></div>
      <div class="skeleton-line short"></div>
    </div>

    <!-- Content -->
    <div id="pw-content" class="pw-content">
      <img id="pw-logo" class="pw-logo" src="" alt="" style="display: none;" />
      <h2 id="pw-name" class="pw-name"></h2>
      <p id="pw-subtitle" class="pw-subtitle"></p>
      <div id="pw-details" class="pw-details"></div>
    </div>

    <!-- Error -->
    <div id="pw-error" class="pw-error">
      <p>Unable to load profile</p>
    </div>
  </div>

  <!-- Compare Button (+ icon) -->
  <button
    id="pw-compare-btn"
    class="pw-compare-btn hidden"
    type="button"
    title="Compare with another entity"
    aria-label="Add comparison"
  >
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M12 5v14M5 12h14" />
    </svg>
  </button>

  <!-- Navigation Button -->
  <a id="pw-button" href="#" class="pw-button">{buttonText}</a>
</div>

<style>
  .profile-widget {
    width: 100%;
    max-width: 600px;
    text-align: center;
    padding: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    border-radius: 0.375rem;
    overflow: hidden;
    position: relative;
  }

  .pw-compare-btn {
    position: absolute;
    top: 0.75rem;
    right: 0.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    padding: 0;
    background-color: var(--bg);
    border: 1px solid var(--border);
    border-radius: 50%;
    cursor: pointer;
    color: var(--text-tertiary);
    transition: color 0.15s, border-color 0.15s;
    z-index: 5;
  }

  .pw-compare-btn:hover {
    color: var(--text-secondary);
    border-color: var(--text-tertiary);
  }

  .pw-compare-btn.hidden {
    display: none;
  }

  :global(.dark) .pw-compare-btn {
    background-color: var(--bg-dark);
    border-color: var(--border-dark);
    color: var(--text-tertiary-dark);
  }

  :global(.dark) .pw-compare-btn:hover {
    color: var(--text-secondary-dark);
    border-color: var(--text-tertiary-dark);
  }

  .pw-body {
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.75rem;
    width: 100%;
  }

  .pw-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
  }

  .pw-content, .pw-error {
    display: none;
    flex-direction: column;
    align-items: center;
    gap: 0.75rem;
  }

  .skeleton-circle {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    background: var(--border);
    animation: pulse 1.5s ease-in-out infinite;
  }

  .skeleton-line {
    height: 14px;
    width: 180px;
    border-radius: 4px;
    background: var(--border);
    animation: pulse 1.5s ease-in-out infinite;
  }

  .skeleton-line.short {
    width: 120px;
  }

  :global(.dark) .skeleton-circle,
  :global(.dark) .skeleton-line {
    background: var(--border-dark);
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  .pw-logo {
    width: 80px;
    height: 80px;
    object-fit: contain;
    margin-bottom: 0.5rem;
  }

  .pw-name {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text);
    margin: 0;
  }

  :global(.dark) .pw-name {
    color: var(--text-dark);
  }

  .pw-subtitle {
    font-size: 0.95rem;
    color: var(--text-secondary);
    margin: 0;
  }

  :global(.dark) .pw-subtitle {
    color: var(--text-secondary-dark);
  }

  .pw-details {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 0.75rem 1.5rem;
    margin-top: 0.5rem;
    font-size: 0.85rem;
    color: var(--text-secondary);
  }

  :global(.dark) .pw-details {
    color: var(--text-secondary-dark);
  }

  .pw-detail-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.125rem;
  }

  .pw-detail-label {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-tertiary);
  }

  :global(.dark) .pw-detail-label {
    color: var(--text-tertiary-dark);
  }

  .pw-detail-value {
    font-weight: 500;
    color: var(--text);
  }

  :global(.dark) .pw-detail-value {
    color: var(--text-dark);
  }

  .pw-error p {
    color: var(--text-secondary);
  }

  :global(.dark) .pw-error p {
    color: var(--text-secondary-dark);
  }

  .pw-button {
    display: block;
    padding: 0.875rem 1.25rem;
    background-color: var(--accent);
    color: var(--bg);
    text-decoration: none;
    font-weight: 500;
    font-size: 0.9rem;
    width: 100%;
    text-align: center;
  }

  :global(.dark) .pw-button {
    background-color: var(--accent-dark);
    color: var(--bg-dark);
  }

  /* Responsive - Mobile */
  @media (max-width: 480px) {
    .pw-body {
      padding: 1.25rem 1rem;
    }

    .pw-logo {
      width: 64px;
      height: 64px;
    }

    .pw-name {
      font-size: 1.25rem;
    }

    .pw-subtitle {
      font-size: 0.875rem;
    }

    .pw-details {
      gap: 0.5rem 1rem;
      font-size: 0.8rem;
    }

    .pw-detail-label {
      font-size: 0.65rem;
    }

    .pw-button {
      padding: 1rem;
      min-height: 48px;
    }
  }

  /* Extra small screens */
  @media (max-width: 320px) {
    .pw-body {
      padding: 1rem 0.75rem;
    }

    .pw-logo {
      width: 56px;
      height: 56px;
    }

    .pw-name {
      font-size: 1.1rem;
    }

    .pw-details {
      flex-direction: column;
      gap: 0.5rem;
    }
  }
</style>

<script>
  import { escapeHtml, parseEntityParams } from '../lib/utils/dom';
  import { swrFetch, setPageData, CACHE_PRESETS } from '../lib/utils/api-fetcher';

  // API Response types matching scoracle-data backend
  interface TeamInfo {
    id: number;
    name: string;
    abbreviation?: string;
    logo_url?: string;
    conference?: string;
    division?: string;
    city?: string;
  }

  interface ProfileInfo {
    id: number;
    sport_id?: string;
    first_name?: string;
    last_name?: string;
    full_name?: string;
    name?: string; // For teams
    position?: string;
    position_group?: string;
    nationality?: string;
    birth_date?: string;
    birth_place?: string;
    birth_country?: string;
    height_inches?: number;
    weight_lbs?: number;
    photo_url?: string;
    logo_url?: string; // For teams
    current_team_id?: number;
    jersey_number?: number;
    college?: string;
    experience_years?: number;
    is_active?: boolean;
    team?: TeamInfo;
    // Team-specific fields
    venue_name?: string;
    venue_capacity?: number;
    founded?: number;
    country?: string;
    city?: string;
  }

  interface ProfileResponse {
    entity_id: number;
    entity_type: 'player' | 'team';
    sport: string;
    season: number;
    info: ProfileInfo;
  }

  class ProfileWidget {
    private widget: HTMLElement | null = null;
    private apiUrl = '';
    private buttonDest = '';
    private showCompare = false;
    private sport: string | null = null;
    private type: string | null = null;
    private id: string | null = null;

    private loadingEl: HTMLElement | null = null;
    private contentEl: HTMLElement | null = null;
    private errorEl: HTMLElement | null = null;
    private nameEl: HTMLElement | null = null;
    private subtitleEl: HTMLElement | null = null;
    private detailsEl: HTMLElement | null = null;
    private logoEl: HTMLImageElement | null = null;
    private buttonEl: HTMLAnchorElement | null = null;
    private compareBtnEl: HTMLButtonElement | null = null;

    private entityName: string = '';

    constructor() {
      const widget = document.getElementById('profile-widget');
      if (!widget) return;

      this.widget = widget;
      this.apiUrl = widget.dataset.api || 'http://localhost:8000/api/v1';
      this.buttonDest = widget.dataset.dest || 'mentions';
      this.showCompare = widget.dataset.showCompare === 'true';

      const params = parseEntityParams();
      this.sport = params.sport;
      this.type = params.type;
      this.id = params.id;

      this.loadingEl = document.getElementById('pw-loading');
      this.contentEl = document.getElementById('pw-content');
      this.errorEl = document.getElementById('pw-error');
      this.nameEl = document.getElementById('pw-name');
      this.subtitleEl = document.getElementById('pw-subtitle');
      this.detailsEl = document.getElementById('pw-details');
      this.logoEl = document.getElementById('pw-logo') as HTMLImageElement;
      this.buttonEl = document.getElementById('pw-button') as HTMLAnchorElement;
      this.compareBtnEl = document.getElementById('pw-compare-btn') as HTMLButtonElement;

      this.init();
      this.exposeAPI();
    }

    private init() {
      if (this.sport && this.type && this.id && this.buttonEl) {
        this.buttonEl.href = `/${this.buttonDest}?sport=${this.sport}&type=${this.type}&id=${this.id}`;
      }

      // Setup compare button click handler
      if (this.compareBtnEl) {
        this.compareBtnEl.addEventListener('click', () => {
          this.onCompareClick();
        });
      }

      if (!this.sport || !this.type || !this.id) {
        this.showError();
        return;
      }

      this.fetchData();
    }

    private exposeAPI() {
      // Expose widget API for other components
      (window as any).profileWidget = {
        getSport: () => this.sport,
        getType: () => this.type,
        getId: () => this.id,
        getName: () => this.entityName,
        hide: () => this.hide(),
        show: () => this.showWidget(),
      };
    }

    private onCompareClick() {
      // Dispatch event with entity info for the comparison modal
      window.dispatchEvent(new CustomEvent('comparison:add', {
        detail: {
          sport: this.sport,
          type: this.type,
          id: this.id,
          name: this.entityName,
        },
      }));
    }

    private async fetchData() {
      const url = `${this.apiUrl}/widget/profile/${this.type}/${this.id}?sport=${this.sport!.toUpperCase()}`;

      try {
        const { data } = await swrFetch<ProfileResponse>(url, CACHE_PRESETS.widget);

        if (!data || !data.info) {
          this.showError();
          return;
        }

        // Share widget data with other components
        setPageData('widget', data);

        this.renderData(data);
      } catch {
        this.showError();
      }
    }

    private renderData(data: ProfileResponse) {
      const info = data.info;
      let name = '';
      let logo = '';
      let subtitle = '';
      let details: { label: string; value: string }[] = [];

      if (data.entity_type === 'team') {
        // Team profile
        name = info.name || info.full_name || 'Unknown';
        logo = info.logo_url || '';
        subtitle = info.venue_name || info.city || '';

        if (info.country) {
          details.push({ label: 'Country', value: info.country });
        }
        if (info.founded) {
          details.push({ label: 'Founded', value: String(info.founded) });
        }
        if (info.venue_capacity) {
          details.push({ label: 'Capacity', value: info.venue_capacity.toLocaleString() });
        }
      } else {
        // Player profile
        name = info.full_name || `${info.first_name || ''} ${info.last_name || ''}`.trim() || 'Unknown';
        logo = info.photo_url || '';
        subtitle = info.team?.name || '';

        if (info.position) {
          details.push({ label: 'Position', value: info.position });
        }
        if (info.jersey_number) {
          details.push({ label: 'Number', value: `#${info.jersey_number}` });
        }
        if (info.height_inches) {
          const feet = Math.floor(info.height_inches / 12);
          const inches = info.height_inches % 12;
          details.push({ label: 'Height', value: `${feet}'${inches}"` });
        }
        if (info.weight_lbs) {
          details.push({ label: 'Weight', value: `${info.weight_lbs} lbs` });
        }
        if (info.college) {
          details.push({ label: 'College', value: info.college });
        }
        if (info.experience_years) {
          details.push({ label: 'Experience', value: `${info.experience_years} yrs` });
        }
        if (info.birth_country) {
          details.push({ label: 'Country', value: info.birth_country });
        } else if (info.nationality) {
          details.push({ label: 'Nationality', value: info.nationality });
        }
      }

      // Store entity name for API
      this.entityName = name;

      if (this.nameEl) this.nameEl.textContent = name;
      if (this.subtitleEl) this.subtitleEl.textContent = subtitle;

      // Render details
      if (this.detailsEl && details.length > 0) {
        this.detailsEl.innerHTML = details.map(d => `
          <div class="pw-detail-item">
            <span class="pw-detail-label">${escapeHtml(d.label)}</span>
            <span class="pw-detail-value">${escapeHtml(d.value)}</span>
          </div>
        `).join('');
      }

      if (this.logoEl && logo) {
        this.logoEl.src = logo;
        this.logoEl.alt = name;
        this.logoEl.style.display = 'block';
      }

      this.showContent();

      // Show compare button if enabled
      if (this.showCompare && this.compareBtnEl) {
        this.compareBtnEl.classList.remove('hidden');
      }
    }

    private showContent() {
      if (this.loadingEl) this.loadingEl.style.display = 'none';
      if (this.contentEl) this.contentEl.style.display = 'flex';
      if (this.errorEl) this.errorEl.style.display = 'none';
    }

    private showError() {
      if (this.loadingEl) this.loadingEl.style.display = 'none';
      if (this.contentEl) this.contentEl.style.display = 'none';
      if (this.errorEl) this.errorEl.style.display = 'flex';
    }

    private hide() {
      if (this.widget) this.widget.classList.add('hidden');
    }

    private showWidget() {
      if (this.widget) this.widget.classList.remove('hidden');
    }
  }

  new ProfileWidget();
</script>
