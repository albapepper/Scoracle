---
/**
 * Stats Comparison
 *
 * Displays statistics for two entities side-by-side for comparison.
 * Fetches: GET /api/v1/stats/{entity_type}/{entity_id}?sport={sport}
 * Shows colored bars for visual differentiation and a legend.
 * Used on the stats page when comparison mode is active.
 */

interface Props {
  title?: string;
}

const { title = "Statistics Comparison" } = Astro.props;
const apiUrl = import.meta.env.PUBLIC_API_URL || 'http://localhost:8000/api/v1';
---

<div id="stats-comparison" class="stats-comparison card hidden" data-api-url={apiUrl}>
  <!-- Header -->
  <div class="stats-card-header">
    <h3 class="stats-card-title">{title}</h3>
    <span id="stats-comparison-season" class="stats-card-season"></span>
  </div>

  <!-- Legend -->
  <div class="stats-comparison-legend">
    <div class="legend-item">
      <span class="legend-bar primary"></span>
      <span id="stats-legend-primary" class="legend-name">Primary</span>
    </div>
    <div class="legend-item">
      <span class="legend-bar secondary"></span>
      <span id="stats-legend-secondary" class="legend-name">Comparison</span>
    </div>
  </div>

  <!-- Content -->
  <div class="stats-card-body">
    <!-- Loading State -->
    <div id="stats-comparison-loading" class="stats-loading">
      <div class="skeleton-row">
        <div class="skeleton-cell label"></div>
        <div class="skeleton-cell bars"></div>
      </div>
      <div class="skeleton-row">
        <div class="skeleton-cell label"></div>
        <div class="skeleton-cell bars"></div>
      </div>
      <div class="skeleton-row">
        <div class="skeleton-cell label"></div>
        <div class="skeleton-cell bars"></div>
      </div>
      <div class="skeleton-row">
        <div class="skeleton-cell label"></div>
        <div class="skeleton-cell bars"></div>
      </div>
    </div>

    <!-- Data Table -->
    <div id="stats-comparison-content" class="stats-comparison-content hidden">
      <div id="stats-comparison-rows" class="stats-rows">
        <!-- Rows populated by JavaScript -->
      </div>
    </div>

    <!-- Empty State -->
    <div id="stats-comparison-empty" class="stats-empty hidden">
      <p>No statistics available for comparison</p>
    </div>

    <!-- Error State -->
    <div id="stats-comparison-error" class="stats-error hidden">
      <p>Unable to load statistics</p>
    </div>
  </div>
</div>

<style>
  .stats-comparison {
    width: 100%;
    max-width: 600px;
    display: flex;
    flex-direction: column;
    border-radius: 0.375rem;
    overflow: hidden;
  }

  .stats-comparison.hidden {
    display: none;
  }

  .stats-card-header {
    padding: 1.25rem 1.5rem 0.75rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .stats-card-title {
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
    color: var(--text);
    line-height: 1.4;
  }

  :global(.dark) .stats-card-title {
    color: var(--text-dark);
  }

  .stats-card-season {
    font-size: 0.8rem;
    color: var(--text-secondary);
    font-weight: 500;
  }

  :global(.dark) .stats-card-season {
    color: var(--text-secondary-dark);
  }

  .stats-comparison-legend {
    display: flex;
    justify-content: center;
    gap: 1.5rem;
    padding: 0.5rem 1.5rem 0.75rem;
    border-bottom: 1px solid var(--border);
  }

  :global(.dark) .stats-comparison-legend {
    border-bottom-color: var(--border-dark);
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .legend-bar {
    width: 16px;
    height: 8px;
    border-radius: 2px;
  }

  .legend-bar.primary {
    background-color: var(--compare-primary);
  }

  .legend-bar.secondary {
    background-color: var(--compare-secondary);
  }

  :global(.dark) .legend-bar.primary {
    background-color: var(--compare-primary-dark);
  }

  :global(.dark) .legend-bar.secondary {
    background-color: var(--compare-secondary-dark);
  }

  .legend-name {
    font-size: 0.75rem;
    color: var(--text-secondary);
    max-width: 100px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  :global(.dark) .legend-name {
    color: var(--text-secondary-dark);
  }

  .stats-card-body {
    padding: 1rem 1.5rem 1.25rem;
  }

  /* Loading Skeleton */
  .stats-loading {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .skeleton-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
  }

  .skeleton-cell {
    height: 14px;
    border-radius: 3px;
    background-color: var(--border);
    animation: pulse 1.5s ease-in-out infinite;
  }

  .skeleton-cell.label {
    width: 30%;
  }

  .skeleton-cell.bars {
    width: 60%;
    height: 24px;
  }

  :global(.dark) .skeleton-cell {
    background-color: var(--border-dark);
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  /* Stats Rows */
  .stats-rows {
    display: flex;
    flex-direction: column;
  }

  :global(.stats-comparison-row) {
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--border);
  }

  :global(.stats-comparison-row:last-child) {
    border-bottom: none;
  }

  :global(.dark .stats-comparison-row) {
    border-bottom-color: var(--border-dark);
  }

  :global(.stats-row-header) {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  :global(.stats-row-label) {
    font-size: 0.85rem;
    color: var(--text-secondary);
    font-weight: 400;
  }

  :global(.dark .stats-row-label) {
    color: var(--text-secondary-dark);
  }

  :global(.stats-row-values) {
    display: flex;
    gap: 0.75rem;
    font-size: 0.85rem;
    font-weight: 500;
    font-variant-numeric: tabular-nums;
  }

  :global(.stats-value-primary) {
    color: var(--compare-primary);
  }

  :global(.stats-value-secondary) {
    color: var(--compare-secondary);
  }

  :global(.dark .stats-value-primary) {
    color: var(--compare-primary-dark);
  }

  :global(.dark .stats-value-secondary) {
    color: var(--compare-secondary-dark);
  }

  :global(.stats-bars-container) {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  :global(.stats-bar-row) {
    display: flex;
    align-items: center;
    height: 12px;
  }

  :global(.stats-bar) {
    height: 100%;
    border-radius: 2px;
    min-width: 4px;
    transition: width 0.3s ease;
  }

  :global(.stats-bar.primary) {
    background-color: var(--compare-primary);
  }

  :global(.stats-bar.secondary) {
    background-color: var(--compare-secondary);
  }

  :global(.dark .stats-bar.primary) {
    background-color: var(--compare-primary-dark);
  }

  :global(.dark .stats-bar.secondary) {
    background-color: var(--compare-secondary-dark);
  }

  /* Empty & Error States */
  .stats-empty,
  .stats-error {
    padding: 1.5rem 0;
    text-align: center;
  }

  .stats-empty p,
  .stats-error p {
    margin: 0;
    font-size: 0.9rem;
    color: var(--text-tertiary);
  }

  :global(.dark) .stats-empty p,
  :global(.dark) .stats-error p {
    color: var(--text-tertiary-dark);
  }

  .hidden {
    display: none !important;
  }

  /* Responsive */
  @media (max-width: 480px) {
    .stats-card-header {
      padding: 1rem;
      flex-direction: column;
      align-items: flex-start;
      gap: 0.25rem;
    }

    .stats-card-title {
      font-size: 0.9rem;
    }

    .stats-comparison-legend {
      padding: 0.5rem 1rem 0.75rem;
      gap: 1rem;
    }

    .stats-card-body {
      padding: 0.75rem 1rem 1rem;
    }

    :global(.stats-comparison-row) {
      padding: 0.625rem 0;
    }

    :global(.stats-row-label) {
      font-size: 0.8rem;
    }

    :global(.stats-row-values) {
      font-size: 0.8rem;
    }
  }
</style>

<script>
  import { escapeHtml } from '../lib/utils/dom';
  import { swrFetch } from '../lib/utils/api-fetcher';

  /**
   * StatsComparisonManager
   *
   * Manages the stats comparison component, fetching and displaying
   * stats for both entities with visual comparison bars.
   */
  class StatsComparisonManager {
    private container: HTMLElement | null = null;
    private apiUrl: string = '';

    private primaryStats: Array<{ label: string; value: string | number }> = [];
    private secondaryStats: Array<{ label: string; value: string | number }> = [];
    private primaryName: string = 'Primary';
    private secondaryName: string = 'Comparison';

    constructor() {
      this.container = document.getElementById('stats-comparison');
      if (!this.container) return;

      this.apiUrl = this.container.dataset.apiUrl || '';
      this.exposeAPI();
    }

    private exposeAPI() {
      (window as any).statsComparison = {
        show: (
          sport: string,
          primaryType: string,
          primaryId: string,
          secondaryType: string,
          secondaryId: string,
          primaryName?: string,
          secondaryName?: string
        ) => {
          this.primaryName = primaryName || 'Primary';
          this.secondaryName = secondaryName || 'Comparison';
          this.show(sport, primaryType, primaryId, secondaryType, secondaryId);
        },
        hide: () => this.hide(),
        isVisible: () => this.isVisible(),
      };
    }

    public async show(
      sport: string,
      primaryType: string,
      primaryId: string,
      secondaryType: string,
      secondaryId: string
    ) {
      if (!this.container) return;

      // Show widget and loading state
      this.container.classList.remove('hidden');
      this.showLoading();

      // Update legend names
      const primaryLegendEl = document.getElementById('stats-legend-primary');
      const secondaryLegendEl = document.getElementById('stats-legend-secondary');
      if (primaryLegendEl) primaryLegendEl.textContent = this.primaryName;
      if (secondaryLegendEl) secondaryLegendEl.textContent = this.secondaryName;

      // Fetch both stats in parallel
      const [primaryResult, secondaryResult] = await Promise.all([
        this.fetchStats(sport, primaryType, primaryId),
        this.fetchStats(sport, secondaryType, secondaryId),
      ]);

      if (!primaryResult && !secondaryResult) {
        this.showError();
        return;
      }

      if ((!primaryResult?.stats || primaryResult.stats.length === 0) &&
          (!secondaryResult?.stats || secondaryResult.stats.length === 0)) {
        this.showEmpty();
        return;
      }

      this.primaryStats = primaryResult?.stats || [];
      this.secondaryStats = secondaryResult?.stats || [];

      // Update season
      const season = primaryResult?.season || secondaryResult?.season;
      if (season) {
        const seasonEl = document.getElementById('stats-comparison-season');
        if (seasonEl) seasonEl.textContent = `${season} Season`;
      }

      this.renderComparison();
    }

    private async fetchStats(
      sport: string,
      type: string,
      id: string
    ): Promise<{ stats: Array<{ label: string; value: string | number }>; season?: string } | null> {
      // Fetch stats from the stats endpoint
      const url = `${this.apiUrl}/stats/${type}/${id}?sport=${sport.toUpperCase()}`;

      try {
        const { data } = await swrFetch<{
          info?: Record<string, unknown>;
          stats?: Record<string, unknown>;
        }>(url, {
          staleTime: 5 * 60 * 1000,
          cacheTime: 30 * 60 * 1000,
        });

        if (!data || !data.stats) {
          return null;
        }

        // Transform flat stats to label/value format
        const statLabels: Record<string, string> = {
          points: 'Points', games: 'Games', assists: 'Assists',
          totReb: 'Rebounds', steals: 'Steals', blocks: 'Blocks',
          fgp: 'FG %', ftp: 'FT %', tpp: '3PT %', plusMinus: '+/-',
          goals: 'Goals', shots: 'Shots', passes: 'Passes',
          tackles: 'Tackles', passing_yards: 'Pass Yards',
          rushing_yards: 'Rush Yards', receiving_yards: 'Rec Yards',
        };

        const stats: Array<{ label: string; value: string | number }> = [];
        for (const [key, value] of Object.entries(data.stats)) {
          if (value !== null && value !== undefined && key !== 'season' && key !== 'player_id' && key !== 'team_id') {
            stats.push({
              label: statLabels[key] || key,
              value: value as string | number,
            });
          }
        }

        return { stats, season: String(data.stats.season || '') };
      } catch {
        return null;
      }
    }

    private renderComparison() {
      const rowsEl = document.getElementById('stats-comparison-rows');
      if (!rowsEl) return;

      // Create a merged list of all stats labels
      const allLabels = new Set<string>();
      this.primaryStats.forEach(s => allLabels.add(s.label));
      this.secondaryStats.forEach(s => allLabels.add(s.label));

      // Create lookup maps
      const primaryMap = new Map(this.primaryStats.map(s => [s.label, s.value]));
      const secondaryMap = new Map(this.secondaryStats.map(s => [s.label, s.value]));

      // Render rows
      const rows: string[] = [];
      allLabels.forEach(label => {
        const primaryValue = primaryMap.get(label);
        const secondaryValue = secondaryMap.get(label);

        // Parse numeric values for bar calculation
        const primaryNum = this.parseNumericValue(primaryValue);
        const secondaryNum = this.parseNumericValue(secondaryValue);

        // Calculate bar widths (as percentage of max)
        let primaryWidth = 0;
        let secondaryWidth = 0;

        if (primaryNum !== null || secondaryNum !== null) {
          const max = Math.max(primaryNum || 0, secondaryNum || 0);
          if (max > 0) {
            primaryWidth = primaryNum !== null ? (primaryNum / max) * 100 : 0;
            secondaryWidth = secondaryNum !== null ? (secondaryNum / max) * 100 : 0;
          }
        }

        const primaryDisplay = primaryValue !== undefined ? String(primaryValue) : '-';
        const secondaryDisplay = secondaryValue !== undefined ? String(secondaryValue) : '-';

        rows.push(`
          <div class="stats-comparison-row">
            <div class="stats-row-header">
              <span class="stats-row-label">${escapeHtml(label)}</span>
              <span class="stats-row-values">
                <span class="stats-value-primary">${escapeHtml(primaryDisplay)}</span>
                <span style="color: var(--text-tertiary)">vs</span>
                <span class="stats-value-secondary">${escapeHtml(secondaryDisplay)}</span>
              </span>
            </div>
            <div class="stats-bars-container">
              <div class="stats-bar-row">
                <div class="stats-bar primary" style="width: ${primaryWidth}%"></div>
              </div>
              <div class="stats-bar-row">
                <div class="stats-bar secondary" style="width: ${secondaryWidth}%"></div>
              </div>
            </div>
          </div>
        `);
      });

      rowsEl.innerHTML = rows.join('');
      this.showContent();
    }

    private parseNumericValue(value: string | number | undefined): number | null {
      if (value === undefined || value === null || value === '-') return null;

      // Handle string values
      if (typeof value === 'string') {
        // Remove common suffixes like %, etc.
        const cleaned = value.replace(/[%,]/g, '').trim();
        const num = parseFloat(cleaned);
        return isNaN(num) ? null : num;
      }

      return typeof value === 'number' ? value : null;
    }

    private showLoading() {
      this.container?.querySelector('#stats-comparison-loading')?.classList.remove('hidden');
      this.container?.querySelector('#stats-comparison-content')?.classList.add('hidden');
      this.container?.querySelector('#stats-comparison-empty')?.classList.add('hidden');
      this.container?.querySelector('#stats-comparison-error')?.classList.add('hidden');
    }

    private showContent() {
      this.container?.querySelector('#stats-comparison-loading')?.classList.add('hidden');
      this.container?.querySelector('#stats-comparison-content')?.classList.remove('hidden');
      this.container?.querySelector('#stats-comparison-empty')?.classList.add('hidden');
      this.container?.querySelector('#stats-comparison-error')?.classList.add('hidden');
    }

    private showEmpty() {
      this.container?.querySelector('#stats-comparison-loading')?.classList.add('hidden');
      this.container?.querySelector('#stats-comparison-content')?.classList.add('hidden');
      this.container?.querySelector('#stats-comparison-empty')?.classList.remove('hidden');
      this.container?.querySelector('#stats-comparison-error')?.classList.add('hidden');
    }

    private showError() {
      this.container?.querySelector('#stats-comparison-loading')?.classList.add('hidden');
      this.container?.querySelector('#stats-comparison-content')?.classList.add('hidden');
      this.container?.querySelector('#stats-comparison-empty')?.classList.add('hidden');
      this.container?.querySelector('#stats-comparison-error')?.classList.remove('hidden');
    }

    public hide() {
      this.container?.classList.add('hidden');
      this.primaryStats = [];
      this.secondaryStats = [];
    }

    public isVisible(): boolean {
      return this.container ? !this.container.classList.contains('hidden') : false;
    }
  }

  // Initialize
  new StatsComparisonManager();
</script>
