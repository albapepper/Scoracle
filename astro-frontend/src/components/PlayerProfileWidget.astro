---
/**
 * Player Profile Widget
 *
 * Displays player profile information from the backend.
 * Fetches: GET /api/v1/profile/player/{player_id}?sport={sport}
 *
 * Expected response structure (raw from backend):
 * {
 *   id, first_name, last_name, full_name, position, photo_url,
 *   jersey_number, height_inches, weight_lbs, college, experience_years,
 *   nationality, birth_date, birth_country,
 *   team: { id, name, logo_url }
 * }
 */

interface Props {
  page?: 'news' | 'stats';
  showCompareButton?: boolean;
}

const { page = 'news', showCompareButton = false } = Astro.props;
const buttonText = page === 'news' ? 'View Stats' : 'View News';
const buttonDest = page === 'news' ? 'stats' : 'news';
const apiUrl = import.meta.env.PUBLIC_API_URL || 'http://localhost:8000/api/v1';
---

<div
  id="player-profile-widget"
  class="profile-widget card"
  data-api={apiUrl}
  data-dest={buttonDest}
  data-show-compare={showCompareButton ? 'true' : 'false'}
>
  <div class="pw-body">
    <!-- Loading -->
    <div id="player-pw-loading" class="pw-loading">
      <div class="skeleton-circle"></div>
      <div class="skeleton-line"></div>
      <div class="skeleton-line short"></div>
    </div>

    <!-- Content -->
    <div id="player-pw-content" class="pw-content">
      <img id="player-pw-logo" class="pw-logo" src="" alt="" style="display: none;" />
      <h2 id="player-pw-name" class="pw-name"></h2>
      <p id="player-pw-subtitle" class="pw-subtitle"></p>
      <div id="player-pw-details" class="pw-details"></div>
    </div>

    <!-- Error -->
    <div id="player-pw-error" class="pw-error">
      <p>Unable to load player profile</p>
    </div>
  </div>

  <!-- Compare Button (+ icon) -->
  <button
    id="player-pw-compare-btn"
    class="pw-compare-btn hidden"
    type="button"
    title="Compare with another player"
    aria-label="Add comparison"
  >
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M12 5v14M5 12h14" />
    </svg>
  </button>

  <!-- Navigation Button -->
  <a id="player-pw-button" href="#" class="pw-button">{buttonText}</a>
</div>

<style>
  .profile-widget {
    width: 100%;
    max-width: 600px;
    text-align: center;
    padding: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    border-radius: 0.375rem;
    overflow: hidden;
    position: relative;
  }

  .pw-compare-btn {
    position: absolute;
    top: 0.75rem;
    right: 0.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    padding: 0;
    background-color: var(--bg);
    border: 1px solid var(--border);
    border-radius: 50%;
    cursor: pointer;
    color: var(--text-tertiary);
    transition: color 0.15s, border-color 0.15s;
    z-index: 5;
  }

  .pw-compare-btn:hover {
    color: var(--text-secondary);
    border-color: var(--text-tertiary);
  }

  .pw-compare-btn.hidden {
    display: none;
  }

  :global(.dark) .pw-compare-btn {
    background-color: var(--bg-dark);
    border-color: var(--border-dark);
    color: var(--text-tertiary-dark);
  }

  :global(.dark) .pw-compare-btn:hover {
    color: var(--text-secondary-dark);
    border-color: var(--text-tertiary-dark);
  }

  .pw-body {
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.75rem;
    width: 100%;
  }

  .pw-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
  }

  .pw-content, .pw-error {
    display: none;
    flex-direction: column;
    align-items: center;
    gap: 0.75rem;
  }

  .skeleton-circle {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    background: var(--border);
    animation: pulse 1.5s ease-in-out infinite;
  }

  .skeleton-line {
    height: 14px;
    width: 180px;
    border-radius: 4px;
    background: var(--border);
    animation: pulse 1.5s ease-in-out infinite;
  }

  .skeleton-line.short {
    width: 120px;
  }

  :global(.dark) .skeleton-circle,
  :global(.dark) .skeleton-line {
    background: var(--border-dark);
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  .pw-logo {
    width: 80px;
    height: 80px;
    object-fit: contain;
    margin-bottom: 0.5rem;
  }

  .pw-name {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text);
    margin: 0;
  }

  :global(.dark) .pw-name {
    color: var(--text-dark);
  }

  .pw-subtitle {
    font-size: 0.95rem;
    color: var(--text-secondary);
    margin: 0;
  }

  :global(.dark) .pw-subtitle {
    color: var(--text-secondary-dark);
  }

  .pw-details {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 0.75rem 1.5rem;
    margin-top: 0.5rem;
    font-size: 0.85rem;
    color: var(--text-secondary);
  }

  :global(.dark) .pw-details {
    color: var(--text-secondary-dark);
  }

  .profile-widget :global(.pw-detail-item) {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.125rem;
  }

  .profile-widget :global(.pw-detail-label) {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-tertiary);
  }

  :global(.dark) .profile-widget :global(.pw-detail-label) {
    color: var(--text-tertiary-dark);
  }

  .profile-widget :global(.pw-detail-value) {
    font-weight: 500;
    color: var(--text);
  }

  :global(.dark) .profile-widget :global(.pw-detail-value) {
    color: var(--text-dark);
  }

  .pw-error p {
    color: var(--text-secondary);
  }

  :global(.dark) .pw-error p {
    color: var(--text-secondary-dark);
  }

  .pw-button {
    display: block;
    padding: 0.875rem 1.25rem;
    background-color: var(--accent);
    color: var(--bg);
    text-decoration: none;
    font-weight: 500;
    font-size: 0.9rem;
    width: 100%;
    text-align: center;
  }

  :global(.dark) .pw-button {
    background-color: var(--accent-dark);
    color: var(--bg-dark);
  }

  /* Responsive - Mobile */
  @media (max-width: 480px) {
    .pw-body {
      padding: 1.25rem 1rem;
    }

    .pw-logo {
      width: 64px;
      height: 64px;
    }

    .pw-name {
      font-size: 1.25rem;
    }

    .pw-subtitle {
      font-size: 0.875rem;
    }

    .pw-details {
      gap: 0.5rem 1rem;
      font-size: 0.8rem;
    }

    .profile-widget :global(.pw-detail-label) {
      font-size: 0.65rem;
    }

    .pw-button {
      padding: 1rem;
      min-height: 48px;
    }
  }

  /* Extra small screens */
  @media (max-width: 320px) {
    .pw-body {
      padding: 1rem 0.75rem;
    }

    .pw-logo {
      width: 56px;
      height: 56px;
    }

    .pw-name {
      font-size: 1.1rem;
    }

    .pw-details {
      flex-direction: column;
      gap: 0.5rem;
    }
  }
</style>

<script>
  import { escapeHtml, parseEntityParams } from '../lib/utils/dom';
  import { swrFetch, setPageData, CACHE_PRESETS } from '../lib/utils/api-fetcher';

  /**
   * Player profile data shape from backend
   */
  interface PlayerProfileData {
    id: number;
    first_name?: string;
    last_name?: string;
    full_name?: string;
    position?: string;
    photo_url?: string;
    jersey_number?: number;
    height_inches?: number;
    weight_lbs?: number;
    college?: string;
    experience_years?: number;
    nationality?: string;
    birth_date?: string;
    birth_country?: string;
    team?: {
      id: number;
      name: string;
      logo_url?: string;
    };
  }

  class PlayerProfileWidget {
    private widget: HTMLElement | null = null;
    private apiUrl = '';
    private buttonDest = '';
    private showCompare = false;
    private sport: string | null = null;
    private id: string | null = null;

    private loadingEl: HTMLElement | null = null;
    private contentEl: HTMLElement | null = null;
    private errorEl: HTMLElement | null = null;
    private nameEl: HTMLElement | null = null;
    private subtitleEl: HTMLElement | null = null;
    private detailsEl: HTMLElement | null = null;
    private logoEl: HTMLImageElement | null = null;
    private buttonEl: HTMLAnchorElement | null = null;
    private compareBtnEl: HTMLButtonElement | null = null;

    private entityName: string = '';

    constructor() {
      const widget = document.getElementById('player-profile-widget');
      if (!widget) return;

      this.widget = widget;
      this.apiUrl = widget.dataset.api || 'http://localhost:8000/api/v1';
      this.buttonDest = widget.dataset.dest || 'news';
      this.showCompare = widget.dataset.showCompare === 'true';

      const params = parseEntityParams();
      this.sport = params.sport;
      this.id = params.id;

      // Only proceed if this is a player entity
      if (params.type !== 'player') return;

      this.loadingEl = document.getElementById('player-pw-loading');
      this.contentEl = document.getElementById('player-pw-content');
      this.errorEl = document.getElementById('player-pw-error');
      this.nameEl = document.getElementById('player-pw-name');
      this.subtitleEl = document.getElementById('player-pw-subtitle');
      this.detailsEl = document.getElementById('player-pw-details');
      this.logoEl = document.getElementById('player-pw-logo') as HTMLImageElement;
      this.buttonEl = document.getElementById('player-pw-button') as HTMLAnchorElement;
      this.compareBtnEl = document.getElementById('player-pw-compare-btn') as HTMLButtonElement;

      this.init();
      this.exposeAPI();
    }

    private init() {
      if (this.sport && this.id && this.buttonEl) {
        this.buttonEl.href = `/${this.buttonDest}?sport=${this.sport}&type=player&id=${this.id}`;
      }

      // Setup compare button click handler
      if (this.compareBtnEl) {
        this.compareBtnEl.addEventListener('click', () => {
          this.onCompareClick();
        });
      }

      if (!this.sport || !this.id) {
        this.showError();
        return;
      }

      this.fetchData();
    }

    private exposeAPI() {
      // Expose widget API for other components
      (window as any).playerProfileWidget = {
        getSport: () => this.sport,
        getType: () => 'player',
        getId: () => this.id,
        getName: () => this.entityName,
        hide: () => this.hide(),
        show: () => this.showWidget(),
      };
    }

    private onCompareClick() {
      window.dispatchEvent(new CustomEvent('comparison:add', {
        detail: {
          sport: this.sport,
          type: 'player',
          id: this.id,
          name: this.entityName,
        },
      }));
    }

    private async fetchData() {
      const url = `${this.apiUrl}/profile/player/${this.id}?sport=${this.sport!.toUpperCase()}`;

      try {
        const { data } = await swrFetch<PlayerProfileData>(url, CACHE_PRESETS.widget);

        if (!data || !data.id) {
          this.showError();
          return;
        }

        // Share widget data with other components (raw data with entity metadata)
        setPageData('widget', {
          entity_id: data.id,
          entity_type: 'player',
          sport: this.sport,
          info: data,
        });

        this.renderData(data);
      } catch {
        this.showError();
      }
    }

    private renderData(data: PlayerProfileData) {
      // Extract player-specific fields
      const name = data.full_name || `${data.first_name || ''} ${data.last_name || ''}`.trim() || 'Unknown Player';
      const logo = data.photo_url || '';
      const subtitle = data.team?.name || '';

      // Build details array for player
      const details: { label: string; value: string }[] = [];

      if (data.position) {
        details.push({ label: 'Position', value: data.position });
      }
      if (data.jersey_number) {
        details.push({ label: 'Number', value: `#${data.jersey_number}` });
      }
      if (data.height_inches) {
        const feet = Math.floor(data.height_inches / 12);
        const inches = data.height_inches % 12;
        details.push({ label: 'Height', value: `${feet}'${inches}"` });
      }
      if (data.weight_lbs) {
        details.push({ label: 'Weight', value: `${data.weight_lbs} lbs` });
      }
      if (data.college) {
        details.push({ label: 'College', value: data.college });
      }
      if (data.experience_years !== undefined && data.experience_years !== null) {
        details.push({ label: 'Experience', value: `${data.experience_years} yrs` });
      }
      if (data.birth_country) {
        details.push({ label: 'Country', value: data.birth_country });
      } else if (data.nationality) {
        details.push({ label: 'Nationality', value: data.nationality });
      }

      // Store entity name for API
      this.entityName = name;

      if (this.nameEl) this.nameEl.textContent = name;
      if (this.subtitleEl) this.subtitleEl.textContent = subtitle;

      // Render details
      if (this.detailsEl && details.length > 0) {
        this.detailsEl.innerHTML = details.map(d => `
          <div class="pw-detail-item">
            <span class="pw-detail-label">${escapeHtml(d.label)}</span>
            <span class="pw-detail-value">${escapeHtml(d.value)}</span>
          </div>
        `).join('');
      }

      if (this.logoEl && logo) {
        this.logoEl.src = logo;
        this.logoEl.alt = name;
        this.logoEl.style.display = 'block';
      }

      this.showContent();

      // Show compare button if enabled
      if (this.showCompare && this.compareBtnEl) {
        this.compareBtnEl.classList.remove('hidden');
      }
    }

    private showContent() {
      if (this.loadingEl) this.loadingEl.style.display = 'none';
      if (this.contentEl) this.contentEl.style.display = 'flex';
      if (this.errorEl) this.errorEl.style.display = 'none';
    }

    private showError() {
      if (this.loadingEl) this.loadingEl.style.display = 'none';
      if (this.contentEl) this.contentEl.style.display = 'none';
      if (this.errorEl) this.errorEl.style.display = 'flex';
    }

    private hide() {
      if (this.widget) this.widget.classList.add('hidden');
    }

    private showWidget() {
      if (this.widget) this.widget.classList.remove('hidden');
    }
  }

  new PlayerProfileWidget();
</script>
