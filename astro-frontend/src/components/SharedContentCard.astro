---
/**
 * Shared Content Card
 *
 * Displays content (articles and tweets) where both entities are mentioned together.
 * Used on the co-mentions comparison page with a tabbed interface.
 */

const apiUrl = import.meta.env.PUBLIC_API_URL || 'http://localhost:8000/api/v1';
---

<div id="shared-content-card" class="shared-content-card card" data-api-url={apiUrl}>
  <!-- Tab Navigation -->
  <div class="tabs-nav">
    <button class="tab-btn active" data-tab="articles">Articles</button>
    <button class="tab-btn" data-tab="tweets">Tweets</button>
  </div>

  <!-- Tab Content -->
  <div class="tabs-content">
    <!-- Articles Tab -->
    <div id="articles-tab" class="tab-content active">
      <div id="articles-loading" class="loading-skeleton">
        <div class="skeleton-item"></div>
        <div class="skeleton-item"></div>
        <div class="skeleton-item"></div>
      </div>
      <div id="articles-content" class="hidden">
        <div id="articles-list" class="content-list"></div>
      </div>
      <div id="articles-empty" class="empty-state hidden">
        No shared articles found
      </div>
    </div>

    <!-- Tweets Tab -->
    <div id="tweets-tab" class="tab-content">
      <div id="tweets-loading" class="loading-skeleton">
        <div class="skeleton-item"></div>
        <div class="skeleton-item"></div>
        <div class="skeleton-item"></div>
      </div>
      <div id="tweets-content" class="hidden">
        <div id="tweets-list" class="content-list"></div>
      </div>
      <div id="tweets-empty" class="empty-state hidden">
        No shared tweets found
      </div>
      <div id="tweets-unavailable" class="empty-state hidden">
        Twitter integration not configured
      </div>
    </div>
  </div>
</div>

<style>
  .shared-content-card {
    width: 100%;
    max-width: 600px;
    padding: 0;
    display: flex;
    flex-direction: column;
    border-radius: 0.375rem;
  }

  .tabs-nav {
    display: flex;
    border-bottom: 1px solid var(--border);
    background-color: transparent;
  }

  :global(.dark) .tabs-nav {
    border-bottom-color: var(--border-dark);
  }

  .tab-btn {
    flex: 1;
    padding: 0.875rem 0.75rem;
    min-height: 48px;
    background: none;
    border: none;
    color: var(--text-secondary);
    font-weight: 500;
    font-size: 0.85rem;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: color 0.15s, border-color 0.15s;
  }

  :global(.dark) .tab-btn {
    color: var(--text-secondary-dark);
  }

  .tab-btn:hover {
    color: var(--text);
  }

  :global(.dark) .tab-btn:hover {
    color: var(--text-dark);
  }

  .tab-btn.active {
    color: var(--text);
    border-bottom-color: var(--text);
  }

  :global(.dark) .tab-btn.active {
    color: var(--text-dark);
    border-bottom-color: var(--text-dark);
  }

  .tabs-content {
    padding: 1.5rem;
    min-height: 300px;
  }

  .tab-content {
    display: none;
  }

  .tab-content.active {
    display: block;
  }

  .loading-skeleton {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .skeleton-item {
    height: 80px;
    border-radius: 4px;
    background-color: var(--border);
    animation: pulse 2s ease-in-out infinite;
  }

  :global(.dark) .skeleton-item {
    background-color: var(--border-dark);
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  .content-list {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .shared-content-card :global(.content-item) {
    padding-bottom: 1.5rem;
    border-bottom: 1px solid var(--border);
  }

  :global(.dark) .shared-content-card :global(.content-item) {
    border-bottom-color: var(--border-dark);
  }

  .shared-content-card :global(.content-item:last-child) {
    border-bottom: none;
    padding-bottom: 0;
  }

  .shared-content-card :global(.content-title) {
    font-weight: 600;
    color: var(--text);
    margin: 0 0 0.5rem 0;
    line-height: 1.4;
    font-size: 0.95rem;
  }

  :global(.dark) .shared-content-card :global(.content-title) {
    color: var(--text-dark);
  }

  .shared-content-card :global(.content-title a) {
    color: inherit;
    text-decoration: underline;
    text-decoration-color: var(--text-tertiary);
    text-underline-offset: 2px;
  }

  :global(.dark) .shared-content-card :global(.content-title a) {
    text-decoration-color: var(--text-tertiary-dark);
  }

  .shared-content-card :global(.content-excerpt) {
    font-size: 0.9rem;
    color: var(--text);
    line-height: 1.5;
    margin: 0;
  }

  :global(.dark) .shared-content-card :global(.content-excerpt) {
    color: var(--text-dark);
  }

  .shared-content-card :global(.content-meta) {
    font-size: 0.8rem;
    color: var(--text-secondary);
    margin-top: 0.5rem;
  }

  :global(.dark) .shared-content-card :global(.content-meta) {
    color: var(--text-secondary-dark);
  }

  .empty-state {
    text-align: center;
    padding: 2rem;
    color: var(--text-secondary);
  }

  :global(.dark) .empty-state {
    color: var(--text-secondary-dark);
  }

  .hidden {
    display: none !important;
  }

  /* Responsive - Mobile */
  @media (max-width: 480px) {
    .tab-btn {
      padding: 0.75rem 0.5rem;
      font-size: 0.8rem;
    }

    .tabs-content {
      padding: 1rem;
    }
  }
</style>

<script>
  import { escapeHtml, parseCoMentionsParams } from '../lib/utils/dom';
  import { formatDate } from '../lib/utils/date';
  import { swrFetch, CACHE_PRESETS } from '../lib/utils/api-fetcher';
  import {
    isValidProfileResponse,
    normalizeProfileResponse,
    type RawProfileResponse,
  } from '../lib/adapters';

  interface Article {
    title: string;
    link: string;
    pub_date?: string;
    source?: string;
  }

  interface Tweet {
    id: string;
    text: string;
    author: string;
    author_username: string;
    created_at: string;
    metrics?: {
      like_count?: number;
      retweet_count?: number;
    };
  }

  interface NewsResponse {
    articles?: Array<{
      title?: string;
      url?: string;
      published_at?: string;
      source?: string;
    }>;
  }

  interface TwitterResponse {
    tweets?: Tweet[];
  }



  interface TwitterStatusResponse {
    configured: boolean;
  }

  class SharedContentCard {
    private card: HTMLElement | null = null;
    private apiUrl = '';
    private params!: ReturnType<typeof parseCoMentionsParams>;
    private articlesLoaded = false;
    private tweetsLoaded = false;
    private primaryName: string | null = null;
    private secondaryName: string | null = null;

    constructor() {
      const card = document.getElementById('shared-content-card');
      if (!card) return;

      this.card = card;
      this.apiUrl = card.dataset.apiUrl || 'http://localhost:8000/api/v1';
      this.params = parseCoMentionsParams();

      this.bindTabEvents();
      this.init();
    }

    private bindTabEvents() {
      if (!this.card) return;

      this.card.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const target = e.currentTarget as HTMLButtonElement;
          const tab = target.dataset.tab;

          // Update active tab button
          this.card!.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          target.classList.add('active');

          // Update active tab content
          this.card!.querySelectorAll('.tab-content').forEach(p => p.classList.remove('active'));
          const panel = document.getElementById(`${tab}-tab`);
          if (panel) panel.classList.add('active');

          // Lazy load tab content
          if (tab === 'tweets' && !this.tweetsLoaded) {
            this.loadTweets();
          }
        });
      });
    }

    private async init() {
      if (!this.params.sport || !this.params.type || !this.params.id) {
        this.showArticlesEmpty();
        return;
      }

      // Fetch entity names in parallel
      const [primaryName, secondaryName] = await Promise.all([
        this.getEntityName(this.params.type!, this.params.id!),
        this.params.coType && this.params.coId
          ? this.getEntityName(this.params.coType, this.params.coId)
          : Promise.resolve(null),
      ]);

      this.primaryName = primaryName;
      this.secondaryName = secondaryName;

      if (!primaryName || !secondaryName) {
        this.showArticlesEmpty();
        return;
      }

      // Load articles immediately (first tab)
      this.loadArticles();
    }

    private async getEntityName(type: string, id: string): Promise<string | null> {
      try {
        const url = `${this.apiUrl}/profile/${type}/${id}?sport=${this.params.sport!.toUpperCase()}`;
        const { data: rawData } = await swrFetch<RawProfileResponse>(url, CACHE_PRESETS.widget);

        if (!isValidProfileResponse(rawData)) return null;

        // Transform raw data using adapter
        const data = normalizeProfileResponse(rawData, type as 'player' | 'team', this.params.sport!);
        const info = data.info;

        if (type === 'team') {
          return info.name || info.full_name || null;
        }
        return info.full_name || `${info.first_name || ''} ${info.last_name || ''}`.trim() || null;
      } catch {
        return null;
      }
    }

    private getSearchTerms(name: string): string[] {
      const terms: string[] = [];
      const lowerName = name.toLowerCase();

      // Add full name
      terms.push(lowerName);

      // Extract and add last name (for players with multi-word names)
      const parts = lowerName.split(/\s+/);
      if (parts.length > 1) {
        let lastName = parts[parts.length - 1];

        // Handle suffixes
        const suffixes = ['jr', 'jr.', 'sr', 'sr.', 'ii', 'iii', 'iv', 'v'];
        if (suffixes.includes(lastName.replace('.', '')) && parts.length >= 3) {
          lastName = parts[parts.length - 2];
        }

        // Only add last name if it's at least 4 characters
        if (lastName.length >= 4) {
          terms.push(lastName);
        }
      }

      return terms;
    }

    private async loadArticles() {
      if (this.articlesLoaded || !this.primaryName || !this.secondaryName) return;
      this.articlesLoaded = true;

      try {
        const newsParams = new URLSearchParams();
        if (this.params.sport) newsParams.set('sport', this.params.sport.toUpperCase());
        newsParams.set('limit', '20');

        const newsUrl = `${this.apiUrl}/news/${this.params.type}/${this.params.id}?${newsParams.toString()}`;
        const { data } = await swrFetch<NewsResponse>(newsUrl, CACHE_PRESETS.news);

        // Transform API response
        const articles: Article[] = (data.articles || []).map(a => ({
          title: a.title || '',
          link: a.url || '',
          pub_date: a.published_at,
          source: a.source,
        }));

        // Build search terms for secondary entity
        const searchTerms = this.getSearchTerms(this.secondaryName);

        // Filter articles that mention secondary entity
        const sharedArticles = articles.filter(article => {
          const title = (article.title || '').toLowerCase();
          return searchTerms.some(term => title.includes(term));
        });

        if (sharedArticles.length === 0) {
          this.showArticlesEmpty();
          return;
        }

        this.renderArticles(sharedArticles);
      } catch {
        this.showArticlesEmpty();
      }
    }

    private renderArticles(articles: Article[]) {
      const listEl = document.getElementById('articles-list');
      if (!listEl) return;

      listEl.innerHTML = articles.map(article => {
        const title = escapeHtml(article.title || 'Untitled');
        const link = article.link || '#';
        const source = escapeHtml(article.source || '');
        const date = formatDate(article.pub_date);

        return `<div class="content-item">
          <h3 class="content-title">
            <a href="${link}" target="_blank" rel="noopener">${title}</a>
          </h3>
          <div class="content-meta">${source}${source && date ? ' 路 ' : ''}${date}</div>
        </div>`;
      }).join('');

      this.showArticlesContent();
    }

    private async loadTweets() {
      if (this.tweetsLoaded || !this.primaryName || !this.secondaryName) return;
      this.tweetsLoaded = true;

      try {
        // Check if Twitter is enabled
        const isEnabled = await this.checkTwitterEnabled();
        if (!isEnabled) {
          this.showTweetsUnavailable();
          return;
        }

        // Fetch tweets for primary entity
        const params = new URLSearchParams();
        params.set('q', this.primaryName);
        params.set('sport', this.params.sport!.toUpperCase());
        params.set('limit', '20');

        const url = `${this.apiUrl}/twitter/journalist-feed?${params.toString()}`;
        const { data } = await swrFetch<TwitterResponse>(url, CACHE_PRESETS.twitter);

        const tweets = data?.tweets || [];

        // Build search terms for secondary entity
        const searchTerms = this.getSearchTerms(this.secondaryName);

        // Filter tweets that mention secondary entity
        const sharedTweets = tweets.filter(tweet => {
          const text = (tweet.text || '').toLowerCase();
          return searchTerms.some(term => text.includes(term));
        });

        if (sharedTweets.length === 0) {
          this.showTweetsEmpty();
          return;
        }

        this.renderTweets(sharedTweets);
      } catch {
        this.showTweetsEmpty();
      }
    }

    private async checkTwitterEnabled(): Promise<boolean> {
      try {
        const { data } = await swrFetch<TwitterStatusResponse>(`${this.apiUrl}/twitter/status`, CACHE_PRESETS.twitter);
        return data?.configured ?? false;
      } catch {
        return false;
      }
    }

    private renderTweets(tweets: Tweet[]) {
      const listEl = document.getElementById('tweets-list');
      if (!listEl) return;

      listEl.innerHTML = tweets.map(tweet => {
        const text = escapeHtml(tweet.text);
        const username = escapeHtml(tweet.author_username);
        const date = formatDate(tweet.created_at);
        const likes = tweet.metrics?.like_count || 0;
        const retweets = tweet.metrics?.retweet_count || 0;

        return `<div class="content-item">
          <p class="content-excerpt">${text}</p>
          <div class="content-meta">@${username} 路 ${date} 路 ${likes} likes 路 ${retweets} retweets</div>
        </div>`;
      }).join('');

      this.showTweetsContent();
    }

    // Article state methods
    private showArticlesContent() {
      document.getElementById('articles-loading')?.classList.add('hidden');
      document.getElementById('articles-content')?.classList.remove('hidden');
      document.getElementById('articles-empty')?.classList.add('hidden');
    }

    private showArticlesEmpty() {
      document.getElementById('articles-loading')?.classList.add('hidden');
      document.getElementById('articles-content')?.classList.add('hidden');
      document.getElementById('articles-empty')?.classList.remove('hidden');
    }

    // Tweet state methods
    private showTweetsContent() {
      document.getElementById('tweets-loading')?.classList.add('hidden');
      document.getElementById('tweets-content')?.classList.remove('hidden');
      document.getElementById('tweets-empty')?.classList.add('hidden');
      document.getElementById('tweets-unavailable')?.classList.add('hidden');
    }

    private showTweetsEmpty() {
      document.getElementById('tweets-loading')?.classList.add('hidden');
      document.getElementById('tweets-content')?.classList.add('hidden');
      document.getElementById('tweets-empty')?.classList.remove('hidden');
      document.getElementById('tweets-unavailable')?.classList.add('hidden');
    }

    private showTweetsUnavailable() {
      document.getElementById('tweets-loading')?.classList.add('hidden');
      document.getElementById('tweets-content')?.classList.add('hidden');
      document.getElementById('tweets-empty')?.classList.add('hidden');
      document.getElementById('tweets-unavailable')?.classList.remove('hidden');
    }
  }

  new SharedContentCard();
</script>
